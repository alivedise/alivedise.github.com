

<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ascheriit</title>
  <meta name="author" content="Alive Kuo">
  <link rel="author" href="humans.txt">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  
    
  
  <meta name="description" content=" Test ">
  
  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://alivedise.github.com/">
  <link href="/favicon.png" rel="icon">
  <link href='http://fonts.googleapis.com/css?family=Cantarell' rel='stylesheet' type='text/css'>
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Ascheriit" type="application/atom+xml">
  <meta name="og:type" content="website" />
  <meta name="og:site_name" content="Ascheriit" />
  <meta name="og:title" content="Ascheriit" />
  <meta name="og:description" content=" Test " />
  <meta name="og:url" content="http://alivedise.github.com/index.html"/>
  <meta name="url" content="http://alivedise.github.com/index.html">
  
  <meta name="distribution" content="global">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-29151691-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <div id="front-wrapper">
  <div id="hero">
    <div id="hero-inner" class="container">
      <div class="span10 offset1">
  <h1>
    Ascheriit
  </h1>
  <h2>I am <em>Alive</em>, a Front-end Developer from <em>Taiwan</em>.</h2>
  <span class="label">Taipei</span> <span class="label">Tokyo</span> <span class="label">Paris</span> <span class="label">San Francisco</span> <span class="label">Berlin</span> <span class="label">Madrid</span>
</div>

    </div>
  </div>
  <section id="sub-hero">
    <div class="container">
      <div class="row">
  <div class="span4">
    <h2>about me</h2>
<pre>
  (function() {
    var Alive = new WebDeveloper();
    Alive.live(_.Taipei);
    Alive.work(_.Mozilla);
    Alive.speak(_.Javascript);
  }());
</pre>
  </div>
  <div class="span6">
    
<h2>recent public projects</h2>
<dl id="gh_repos" class="dl-horizontal" data-github-user="alivedise" data-github-repo-count="5" data-github-skip-forks="true">
  <dd class="loading">Status updating&#8230;</dd>
</dl>
<script src="/javascripts/github.js" type="text/javascript"> </script>
<script src="/javascripts/libs/jXHR.js" type="text/javascript"> </script>


  </div>
  <div class="span2">
    <h2>found on</h2>

<a href="https://github.com/alivedise/" rel="tooltip" title="Github"><img class="social_icon" title="Github" alt="github icon" src="/images/glyphicons_381_github.png"></a>







<a href="http://twitter.com/alivedise" rel="tooltip" title="Twitter"><img class="social_icon" title="Twitter" alt="Twitter icon" src="/images/glyphicons_391_twitter_t.png"></a>








  </div>
</div>

    </div>
  </section>
  <div class="container">
    <div class="row" id="post-container">
    
    
    
      <article class="span4">
        <div class="article-format">

  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/16/audio-competing-in-fxos/">[Fx OS] Background Media Play</a></h1>
    
    
      <p class="meta">
        
  


  
    <span class="byline author vcard">by <span class="fn">Alive Kuo</span></span>
  

 - 
        








  


<time datetime="2013-07-16T19:16:00+08:00" pubdate data-updated="true">Jul 16<span>th</span>, 2013</time> - 
        

posted in
<span class="categories">
  
    <a class='category' href='/blog/categories/audio/'>audio</a>, <a class='category' href='/blog/categories/fxos/'>fxos</a>
  
</span>


        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="https://blog.mozilla.org/press/files/2012/09/FXOS_Music_Grid.jpg"></p>

<p>If you want to have you own media playing app to be able to run at background,
and/or has the ability to interrupt other playing audio, please view this article for what to do.</p>

<h2>Audio Channel Permission</h2>

<p>You need to specify this permission in the manifest of your app.</p>

<p>And yes, this means we don&#8217;t allow a web page without the manifest to play at background.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="s2">&quot;permissions&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;audio-channel-content&quot;</span><span class="o">:</span> <span class="p">{}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>content</code> represents the name of the audio channel.</p>

<p>Note: Video&#8217;s permission also uses the same <code>audio-channel-content</code>.</p>

<h3>Audio Channel Types</h3>

<p>We have five audio channels currently:</p>

<ul>
<li>Normal: Default channel of any media element, including video.</li>
<li>Content: Especailly stands for content like music.</li>
<li>Notification: Include desktop-notification sounds</li>
<li>Ringer: Incoming call ringer</li>
<li>Alarm: Alarm has a specific requirement to interrupt any other channel above.</li>
<li>telephony: Voice.</li>
</ul>


<h4>Volume Settings</h4>

<ul>
<li>Normal and content channel are sharing the same volume settings.</li>
<li>Notification and ringer are another set.</li>
<li>Other has its own settings key.</li>
</ul>


<h3>Audio Competing Rules</h3>

<ol>
<li>We&#8217;re interrupting the lower channel when higher channel occurs.</li>
<li>If the same channel are playing and using content channel,
the one who gets visibility (go to foreground) would be the winner.</li>
<li>The foreground page/app is always playable. However the channel type decides it could interrupt background playing content or not.</li>
<li>The background page/app is playable if and only if the background is causing by screen off,
and the page/app is the current displayed one.</li>
</ol>


<p>I would explain the rules more in another article ;)</p>

<h2>[Statically] HTML Media Element</h2>

<p>You could assign audio channel type to the media elements in HTML.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;audio</span> <span class="na">mozaudiochannel=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;&lt;/audio&gt;</span>
</span><span class='line'><span class="nt">&lt;video</span> <span class="na">mozaudiochannel=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;&lt;/video&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Please keep in mind you need relevant channel permission.</p>

<h2>[Dynamically] Javascript</h2>

<p>Sometimes we need to dynamically generate the player element:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">audio</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Audio</span><span class="p">();</span>
</span><span class='line'><span class="nx">audio</span><span class="p">.</span><span class="nx">mozAudioChannelType</span> <span class="o">=</span> <span class="s1">&#39;content&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Set audio channel type before setting src to avoid decoder confuses.</span>
</span><span class='line'><span class="nx">audio</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s1">&#39;xxx.ogg&#39;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Change the channel of the audio to another type is not allowed.</p>

<p>You should create another audio/video instance if you want to be played in another channel.</p>

<h2>(OPTIONAL) If you want to know you&#8217;re interrupted by higher channel</h2>

<p>Add mozinterruptbegin/mozinterruptend event handler if you need to do something with interruptions.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'>  <span class="kd">var</span> <span class="nx">player</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;audio#my-player&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// ...</span>
</span><span class='line'>  <span class="c1">// The event is fired on the media element. </span>
</span><span class='line'>  <span class="nx">player</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;mozinterruptbegin&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">onInterrupted</span><span class="p">()</span> <span class="p">{</span><span class="c1">//do sth....}); </span>
</span><span class='line'>  <span class="nx">player</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;mozinterruptend&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">onResumed</span><span class="p">()</span> <span class="p">{</span><span class="c1">// do sth....}); </span>
</span></code></pre></td></tr></table></div></figure>


<h2>Notices</h2>

<ul>
<li>Even if your are developing a HTML5 video playing app,
and we all know that video shouldn&#8217;t be played at background due to strange UX,
you should also consider to set content channel because video is expected to interrupt the current background playing media.</li>
</ul>


<h2>Reference</h2>

<ul>
<li><a href="https://wiki.mozilla.org/WebAPI/AudioChannels">Mozilla WIKI: Audio Channel</a></li>
<li><a href="https://groups.google.com/forum/?fromgroups=#!topic/mozilla.dev.gaia/HyAlHdFdX68">B2G Maillist</a></li>
</ul>

</div>
  
  


</div>

      </article>
    
    
      <article class="span4">
        <div class="article-format">

  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/10/system-modulization-plan/">Proposal: System Modulization Plan</a></h1>
    
    
      <p class="meta">
        
  


  
    <span class="byline author vcard">by <span class="fn">Alive Kuo</span></span>
  

 - 
        








  


<time datetime="2013-07-10T18:04:00+08:00" pubdate data-updated="true">Jul 10<span>th</span>, 2013</time> - 
        

posted in
<span class="categories">
  
    <a class='category' href='/blog/categories/b2g/'>b2g</a>, <a class='category' href='/blog/categories/gaia/'>gaia</a>, <a class='category' href='/blog/categories/javascript/'>javascript</a>
  
</span>


        
      </p>
    
  </header>


  <div class="entry-content"><h4>Source</h4>

<p><a href="https://github.com/mozilla-b2g/gaia/tree/master/apps/system">https://github.com/mozilla-b2g/gaia/tree/master/apps/system</a></p>

<h4>Issues with Modulization-less</h4>

<ol>
<li>Some modules directly invokes others.</li>
<li><code>'LockScreen is undefined.'</code> message appears oftenly right after device boots up.</li>
<li>Memory concern - Most of the modules are not always needed. Most of the UI view doesn&#8217;t need to live in the DOM tree at first.</li>
<li>Performance concern - device bootup time is getting longer and longer.</li>
</ol>


<h4>Proposal: Core modules and side modules</h4>

<p>We could figure out what&#8217;s definitely necessary in an operating system and what&#8217;s not.
For example, <code>Window Management</code> relevant modules should be a core module but <code>Captive Portal</code> shouldn&#8217;t be.
The following are current modules list:</p>

<ul>
<li>accessibility.js</li>
<li>activities.js</li>
<li>airplane_mode.js</li>
<li>app_install_manager.js</li>
<li>app_window_manager.js</li>
<li>applications.js</li>
<li>attention_screen.js</li>
<li>authentication_dialog.js</li>
<li>battery_manager.js</li>
<li>bluetooth.js</li>
<li>bluetooth_transfer.js</li>
<li>bootstrap.js</li>
<li>browser_frame.js</li>
<li>call_forwarding.js</li>
<li>captive_portal.js</li>
<li>cards_view.js</li>
<li>cell_broadcast_system.js</li>
<li>context_menu.js</li>
<li>cost_control.js</li>
<li>crash_reporter.js</li>
<li>entry_sheet.js</li>
<li>fake_window_manager.js</li>
<li>ftu_launcher.js</li>
<li>gridview.js</li>
<li>hardware_buttons.js</li>
<li>icc.js</li>
<li>icc_events.js</li>
<li>icc_worker.js</li>
<li>identity.js</li>
<li>init_logo_handler.js</li>
<li>internet_sharing.js</li>
<li>keyboard_manager.js</li>
<li>list_menu.js</li>
<li>lockscreen.js</li>
<li>logo_loader.js</li>
<li>modal_dialog.js</li>
<li>modulelist.txt</li>
<li>mouse2touch.js</li>
<li>notifications.js</li>
<li>operator_variant</li>
<li>orientation_observer.js</li>
<li>payment.js</li>
<li>permission_manager.js</li>
<li>popup_manager.js</li>
<li>quick_settings.js</li>
<li>remote_debugger.js</li>
<li>screen_manager.js</li>
<li>screenshot.js</li>
<li>sim_lock.js</li>
<li>simcard_dialog.js</li>
<li>sleep_menu.js</li>
<li>software_button_manager.js</li>
<li>sound_manager.js</li>
<li>source_view.js</li>
<li>statusbar.js</li>
<li>storage.js</li>
<li>storage_watcher.js</li>
<li>system_banner.js</li>
<li>system_dialog.js</li>
<li>trusted_ui.js</li>
<li>ttlview.js</li>
<li>updatable.js</li>
<li>update_manager.js</li>
<li>utility_tray.js</li>
<li>value_selector</li>
<li>voicemail.js</li>
<li>wifi.js</li>
<li>window.js</li>
<li>window_load_time.js</li>
<li>window_manager.js</li>
<li>wrapper.js</li>
</ul>


<p>The main idea is the same as any other app performanace tuning:
Lazy load anything on demand.</p>

<p>The key to this idea would be to establish the following rules:
* Any side module would have a main event by interest.
* An event dispatcher as a core module to gather all main events of side modules and then lazy load them.
For example, lazy load the Captive Portal:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;mozChromeEvent&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">detail</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;captive-portal-login&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">CaptivePortal</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">lazy</span><span class="o">-</span><span class="nx">load</span><span class="p">(</span><span class="s1">&#39;captive-portal&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">onReadyCallback</span><span class="p">()</span> <span class="p">{</span>   <span class="c1">// lazy load captive portal and its HTML part.</span>
</span><span class='line'>      <span class="nx">CaptivePortal</span><span class="p">.</span><span class="nx">handleEvent</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>  <span class="c1">// Pass the event</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>  <span class="c1">// If we have already load the CaptivePortal, the event listener inside CP would catch the event by itself.</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>So another rule would be:
* expose handleEvent in any side module for Event Dispatcher to invoke when they are firt time loaded by Event Dispatcher.</p>

<p>With this, we could even lazy load lockscreen,
because if lockscreen is disabled by the user, we don&#8217;t need to load it when the device boots.</p>

<p>IMO there&#8217;re only few core modules now:</p>

<ul>
<li>Window Management

<ul>
<li>App Window</li>
<li>Browser Frame</li>
</ul>
</li>
<li>Utility-tray</li>
<li>Statusbar</li>
<li>Init Logo Handler (But this is useless after device boot finishes.)</li>
<li>Screen Management (Exactly, it&#8217;s indeed Wake Lock Management)</li>
<li>Applications (API Wrapper for mozApp)</li>
</ul>


<p>The following are API wrappers which I believe is also important enough to be a core module.</p>

<ul>
<li>Hardware Button Management (Many other modules&#8217; execution route is started here.)</li>
<li>Battery Management (UI-less but more like an API wrapper for mozBattery so I would put this into core module.)</li>
<li>Airplane Mode (API Wrapper of mozSettings: radio.enabled)</li>
<li>Bluetooth (API Wrapper for mozBluetooth)</li>
<li>Cost Control (It already lives inside an iframe.)</li>
<li>Ftu Launcher (Necessary only for one time when device is first time booted.)</li>
<li>Keyboard Management</li>
<li>mouse2touch</li>
<li>Notifications</li>
<li>Orientation observer (API Wrapper for deviceorientation event)</li>
<li>Sound manager (There are too many events involed here.)</li>
<li>Update Management</li>
</ul>


<h5>Chanllenge</h5>

<p>If we want to &#8220;unload&#8221; the module and its view using iframe,
we need a way for modules inside iframe to communicate.
The first thing come to my mind is <code>window.parent.postMessage</code></p>

<p>Second, we need to consider dependency problems if it&#8217;s too complex.</p>
</div>
  
  


</div>

      </article>
    
    
      <article class="span4">
        <div class="article-format">

  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/05/transition-state-machine/">[Window Management] Transition State Machine</a></h1>
    
    
      <p class="meta">
        
  


  
    <span class="byline author vcard">by <span class="fn">Alive Kuo</span></span>
  

 - 
        








  


<time datetime="2013-07-05T14:53:00+08:00" pubdate data-updated="true">Jul 5<span>th</span>, 2013</time> - 
        

posted in
<span class="categories">
  
    <a class='category' href='/blog/categories/css/'>css</a>, <a class='category' href='/blog/categories/javascript/'>javascript</a>
  
</span>


        
      </p>
    
  </header>


  <div class="entry-content"><p>The article is inspired by Tim&#8217;s <a href="http://blog.timc.idv.tw/posts/css-classes-state-machine-puzzle/">CSS Classes State Machine Puzzle</a>.</p>

<p>We had some frustrations all the times, on animating a window correctly.</p>

<p>Recently I try to dedicate on solving the puzzle.
But at first I need to apologize for my poor knowledge and thought about css transitions using class names.</p>

<p>In the past I usually thought it was stupid to use class list to control the style.
I thought it was ambiguous and strange if we ran into a situation that there&#8217;re more than one classes of same type put on one element. And an element full of different class names for different purposes may conflict. Recently I see <a href="https://github.com/h5bp/Effeckt.css">Effeckt</a> and know this is the trend: a simple class name stands for a kind of animation.</p>

<p>The real problem is that we should never put wrong class on the DOM element, in javascript. So this now turns to be a pure javascript puzzle.</p>

<p>We know, that, in certain moment, the app window is always in a specific state A, not B nor C. So what&#8217;s the problem? It&#8217;s how could we switch the state correctly.</p>

<p>Let&#8217;s create a real state machine in javascript!</p>

<p>So far it doesn&#8217;t take times for us to figure out that a window should have 4 basic transition state: <code>closed</code>, <code>opening</code>, <code>opened</code>, <code>closing</code>.</p>

<p>A basic transition life cycle of a window could be:</p>

<blockquote><p>(initial) -> closed -> opening -> opened &#8212;&#8212;> closing -> opening &#8212;&#8212;> &#8230;.</p></blockquote>


<p>Now we have 4 states, the next is what&#8217;s the trigger to states switching?</p>

<p>In finite state machine, what triggers state change is named for <a href="https://en.wikipedia.org/wiki/Finite-state_machine">&#8216;event&#8217;</a>.</p>

<p>We know that at least we have 2 events: &#8216;open&#8217; and &#8216;close&#8217;.</p>

<ul>
<li>&#8216;open&#8217; would trigger <code>closed</code> switches to <code>opening</code></li>
<li>&#8216;close&#8217; would trigger <code>opened</code> switches to <code>closing</code></li>
<li>If we sends &#8216;open&#8217; event into the state machine continously,
the second event would be ignored.
(Exactly it depends on what policy we choose. For example, we could devide &#8216;opening&#8217; state into &#8216;opening-part-1&#8217; and &#8216;opening-part-2&#8217; states. And implement the async state change. But if we need s two-state opening, it sounds like a CSS design problem to me. Let&#8217;s discuss this later if necessary.)</li>
<li>In order to gurantee the transition does really end and thus being independent from the &#8216;animationend&#8217; event(The event here is HTML DOM Event), we need to add a timer between &#8216;opening&#8217; and &#8216;opened&#8217; state. Also between &#8216;closing&#8217; and &#8216;closed&#8217; state.</li>
<li>Let&#8217;s call the new event &#8216;timeout&#8217;, the timing we set the timer is right after the transitioning from &#8216;closed&#8217; to &#8216;opening&#8217;, and from &#8216;opened&#8217; to &#8216;closing&#8217; successfully occurs.</li>
<li>For some use case we may want to cancel the transition. The &#8216;cancel&#8217; event is only valid in &#8216;opening&#8217; and &#8216;closing&#8217; state.</li>
</ul>


<p>So far, the state machine for transition we have:
<img src="http://i.imgur.com/MmBj2pY.jpg"></p>

<p>Now the problem is, how to represent this machine in javascript?</p>

<p>My anwser is put every transition relevant functions/attributes in another mixin object, which would be mixed into appWindow.prototype:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nb">window</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="s1">&#39;use strict&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">capitalize</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">string</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">+</span> <span class="nx">string</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * This object declares all transition event enum:</span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * * OPEN</span>
</span><span class='line'><span class="cm">   * * CLOSE</span>
</span><span class='line'><span class="cm">   * * FINISH</span>
</span><span class='line'><span class="cm">   * * END</span>
</span><span class='line'><span class="cm">   * * CANCEL</span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * @static</span>
</span><span class='line'><span class="cm">   * @namespace TransitionEvent</span>
</span><span class='line'><span class="cm">   * @type {Object}</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">EVT</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">OPEN</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">CLOSE</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">FINISH</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">END</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">CANCEL</span><span class="o">:</span> <span class="mi">4</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">_EVTARRAY</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;OPEN&#39;</span><span class="p">,</span> <span class="s1">&#39;CLOSE&#39;</span><span class="p">,</span> <span class="s1">&#39;FINISH&#39;</span><span class="p">,</span> <span class="s1">&#39;END&#39;</span><span class="p">,</span> <span class="s1">&#39;CANCEL&#39;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Describe the transition state table.</span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * @example</span>
</span><span class='line'><span class="cm">   * var toState = transitionTable[currentState][event];</span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * The value &quot;null&quot; indicates that the transition won&#39;t happen.</span>
</span><span class='line'><span class="cm">   * </span>
</span><span class='line'><span class="cm">   * @type {Object}</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">transitionTable</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>              <span class="cm">/* OPEN|CLOSE|FINISH|END|CANCEL */</span>
</span><span class='line'>    <span class="s1">&#39;closed&#39;</span><span class="o">:</span>  <span class="p">[</span><span class="s1">&#39;opening&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">],</span>
</span><span class='line'>    <span class="s1">&#39;opened&#39;</span><span class="o">:</span>  <span class="p">[</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;closing&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">],</span>
</span><span class='line'>    <span class="s1">&#39;closing&#39;</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;opened&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;closed&#39;</span><span class="p">,</span> <span class="s1">&#39;closed&#39;</span><span class="p">,</span> <span class="s1">&#39;opened&#39;</span><span class="p">],</span>
</span><span class='line'>    <span class="s1">&#39;opening&#39;</span><span class="o">:</span> <span class="p">[</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;closed&#39;</span><span class="p">,</span> <span class="s1">&#39;opened&#39;</span><span class="p">,</span> <span class="s1">&#39;opened&#39;</span><span class="p">,</span> <span class="s1">&#39;closed&#39;</span><span class="p">]</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * This provides methods and attributes used for transition state handling. It&#39;s not meant to</span>
</span><span class='line'><span class="cm">   * be used directly.</span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * The finite state machine of transition is working as(being from normal state):</span>
</span><span class='line'><span class="cm">   * </span>
</span><span class='line'><span class="cm">   * * `closed`  ---*event* **OPEN** ----------------&gt; `opening`</span>
</span><span class='line'><span class="cm">   * * `opening` ---*event* **END/FINISH/CANCEL** ---&gt; `opened`</span>
</span><span class='line'><span class="cm">   * * `opened`  ---*event* **CLOSE** ---------------&gt; `closing`</span>
</span><span class='line'><span class="cm">   * * `closing` ---*event* **END/FINISH/CANCEL** ---&gt; `closed`</span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * If you want to reuse this mixin in your object, you need to define these attributes: `this.element`</span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * And these method: `this.setVisible()` `this.publish()`</span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * The following callback functions are executed only when the transition state are successfully switched:</span>
</span><span class='line'><span class="cm">   * `_onOpen`</span>
</span><span class='line'><span class="cm">   * `_onClose`</span>
</span><span class='line'><span class="cm">   * `_onEnd`</span>
</span><span class='line'><span class="cm">   * `_onFinish`</span>
</span><span class='line'><span class="cm">   * `_onCancel`</span>
</span><span class='line'><span class="cm">   * `_leaveOpened`</span>
</span><span class='line'><span class="cm">   * `_enterOpened`</span>
</span><span class='line'><span class="cm">   * `_leaveClosed`</span>
</span><span class='line'><span class="cm">   * `_enterClosed`</span>
</span><span class='line'><span class="cm">   * `_leaveClosing`</span>
</span><span class='line'><span class="cm">   * `_enterClosing`</span>
</span><span class='line'><span class="cm">   * `_leaveOpening`</span>
</span><span class='line'><span class="cm">   * `_enterOpening`</span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * Every callback here is for internal usage and would be executed only once.</span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * However you could utilize inner event in other functions.</span>
</span><span class='line'><span class="cm">   * </span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * @mixin WindowTransition</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * @event AppWindow#_onTransitionOpen</span>
</span><span class='line'><span class="cm">   * @private</span>
</span><span class='line'><span class="cm">   * @memberof AppWindow</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * @event AppWindow#_onTransitionClose</span>
</span><span class='line'><span class="cm">   * @private</span>
</span><span class='line'><span class="cm">   * @memberof AppWindow</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * @event AppWindow#_onTransitionEnd</span>
</span><span class='line'><span class="cm">   * @private</span>
</span><span class='line'><span class="cm">   * @memberof AppWindow</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * @event AppWindow#_onTransitionFinish</span>
</span><span class='line'><span class="cm">   * @private</span>
</span><span class='line'><span class="cm">   * @memberof AppWindow</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * @event AppWindow#_onTransitionCancel</span>
</span><span class='line'><span class="cm">   * @private</span>
</span><span class='line'><span class="cm">   * @memberof AppWindow</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">WindowTransition</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">TRANSITION_EVENT</span><span class="o">:</span> <span class="nx">EVT</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * _transitionState indicates current transition state of appWindow.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * @memberOf WindowTransition</span>
</span><span class='line'><span class="cm">     * @default</span>
</span><span class='line'><span class="cm">     * @type {String}</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="nx">_transitionState</span><span class="o">:</span> <span class="s1">&#39;closed&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * Record the previous transition state.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * **Only updated if the state changes successfully.**</span>
</span><span class='line'><span class="cm">     * </span>
</span><span class='line'><span class="cm">     * @type {String|null}</span>
</span><span class='line'><span class="cm">     * @memberOf WindowTransition</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="nx">_previousTransitionState</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * Handle the transition event.</span>
</span><span class='line'><span class="cm">     * @memberOf WindowTransition</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="nx">_transitionHandler</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">aw__transitionHandler</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_cancelTransition</span><span class="p">();</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_processTransitionEvent</span><span class="p">(</span><span class="nx">EVT</span><span class="p">.</span><span class="nx">FINISH</span><span class="p">);</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">_cancelTransition</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">aw__cancelTransition</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">className</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">className</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">className</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;transition-&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">className</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">_enterOpening</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">aw__enterOpening</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="cm">/**</span>
</span><span class='line'><span class="cm">       * @todo set this._unloaded</span>
</span><span class='line'><span class="cm">       */</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">resize</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_unloaded</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">//this.element.style.backgroundImage = &#39;url(&#39; + this._splash + &#39;)&#39;;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Turn of visibility once we&#39;re entering opening state.</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">setVisible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Make sure the transition is terminated.</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_openingTransitionTimer</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_previousTransitionState</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>            <span class="k">this</span><span class="p">.</span><span class="nx">_previousTransitionState</span> <span class="o">==</span> <span class="nx">from</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>            <span class="k">this</span><span class="p">.</span><span class="nx">_transitionState</span> <span class="o">==</span> <span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">this</span><span class="p">.</span><span class="nx">_processTransitionEvent</span><span class="p">(</span><span class="nx">EVT</span><span class="p">.</span><span class="nx">END</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">_transitionTimeout</span><span class="o">*</span><span class="mf">1.2</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/**</span>
</span><span class='line'><span class="cm">       * @event AppWindow#appwillopen</span>
</span><span class='line'><span class="cm">       * @memberof AppWindow</span>
</span><span class='line'><span class="cm">       */</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">from</span> <span class="o">!==</span> <span class="s1">&#39;opened&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Only publish |willopen| event when previous state is &quot;closed&quot;.</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;willopen&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;transition-opening&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_transition</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">_enterClosing</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">aw__enterClosing</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Make sure the transition is terminated.</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_closingTransitionTimer</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_previousTransitionState</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>            <span class="k">this</span><span class="p">.</span><span class="nx">_previousTransitionState</span> <span class="o">==</span> <span class="nx">from</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>            <span class="k">this</span><span class="p">.</span><span class="nx">_transitionState</span> <span class="o">==</span> <span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">this</span><span class="p">.</span><span class="nx">_processTransitionEvent</span><span class="p">(</span><span class="nx">EVT</span><span class="p">.</span><span class="nx">END</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">_transitionTimeout</span><span class="o">*</span><span class="mf">1.2</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/**</span>
</span><span class='line'><span class="cm">       * @event AppWindow#appwillclose</span>
</span><span class='line'><span class="cm">       * @memberof AppWindow</span>
</span><span class='line'><span class="cm">       */</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">from</span> <span class="o">!==</span> <span class="s1">&#39;opened&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Only publish |willclose| event when previous state is &quot;opened&quot;.</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;willclose&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;transition-closing&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_transition</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">_processTransitionEvent</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">aw__processTransitionEvent</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">transitionTable</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">_transitionState</span><span class="p">][</span><span class="nx">evt</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">to</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">from</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_transitionState</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">leaveState</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">evt</span><span class="p">);</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">onEvent</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">evt</span><span class="p">);</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">enterState</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">evt</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_previousTransitionState</span> <span class="o">=</span> <span class="nx">from</span><span class="p">;</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_transitionState</span> <span class="o">=</span> <span class="nx">to</span><span class="p">;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">enterState</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">aw_enterState</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">funcName</span> <span class="o">=</span> <span class="s1">&#39;_enter&#39;</span> <span class="o">+</span> <span class="nx">capitalize</span><span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">());</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">funcName</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>          <span class="k">this</span><span class="p">[</span><span class="nx">funcName</span><span class="p">](</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">evt</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">funcName</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">funcName</span><span class="p">]))</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">[</span><span class="nx">funcName</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>            <span class="nx">func</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">evt</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">leaveState</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">aw_leaveState</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">funcName</span> <span class="o">=</span> <span class="s1">&#39;_leave&#39;</span> <span class="o">+</span> <span class="nx">capitalize</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">());</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">funcName</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>          <span class="k">this</span><span class="p">[</span><span class="nx">funcName</span><span class="p">](</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">evt</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">funcName</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">funcName</span><span class="p">]))</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">[</span><span class="nx">funcName</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>            <span class="nx">func</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">evt</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">onEvent</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">aw_onEvent</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">funcName</span> <span class="o">=</span> <span class="s1">&#39;_onTransition&#39;</span> <span class="o">+</span> <span class="nx">capitalize</span><span class="p">(</span><span class="nx">_EVTARRAY</span><span class="p">[</span><span class="nx">evt</span><span class="p">].</span><span class="nx">toLowerCase</span><span class="p">());</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_invoke</span><span class="p">(</span><span class="nx">funcName</span><span class="p">);</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">_enterOpened</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">aw__enterOpened</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_cancelTransition</span><span class="p">();</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_openingTransitionTimer</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">window</span><span class="p">.</span><span class="nx">clearTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_openingTransitionTimer</span><span class="p">);</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">_openingTransitionTimer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="cm">/**</span>
</span><span class='line'><span class="cm">       * @event AppWindow#appopen</span>
</span><span class='line'><span class="cm">       * @memberOf AppWindow</span>
</span><span class='line'><span class="cm">       */</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">from</span> <span class="o">==</span> <span class="s1">&#39;opening&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Only publish |open| event when previous state is &quot;opening&quot;.</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">_enterClosed</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">aw__enterClosed</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_cancelTransition</span><span class="p">();</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_closingTransitionTimer</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">window</span><span class="p">.</span><span class="nx">clearTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_closingTransitionTimer</span><span class="p">);</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">_closingTransitionTimer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">setVisible</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/**</span>
</span><span class='line'><span class="cm">       * @event AppWindow#appclose</span>
</span><span class='line'><span class="cm">       * @memberof AppWindow</span>
</span><span class='line'><span class="cm">       */</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">from</span> <span class="o">==</span> <span class="s1">&#39;closing&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Only publish |close| event when previous state is &quot;closing&quot;.</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * Set the transition way of opening or closing transition.</span>
</span><span class='line'><span class="cm">     * @param  {String} type       &#39;open&#39; or &#39;close&#39;</span>
</span><span class='line'><span class="cm">     * @param  {String} transition The CSS rule name about window transition.</span>
</span><span class='line'><span class="cm">     * @memberOf WindowTransition</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="nx">_setTransition</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">aw__setTransition</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">transition</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">!=</span> <span class="s1">&#39;open&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">type</span> <span class="o">!=</span> <span class="s1">&#39;close&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_transition</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="nx">transition</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">AppWindow</span><span class="p">.</span><span class="nx">addMixin</span><span class="p">(</span><span class="nx">WindowTransition</span><span class="p">);</span>
</span><span class='line'><span class="p">}(</span><span class="k">this</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<h5>The state machine&#8217;s usage and notes</h5>

<ol>
<li>A single app window instance would send &#8216;open&#8217; and &#8216;close&#8217; event due to user action:
<code>
transitionStateMachine.<em>processEvent('open');
transitionStateMachine.</em>processEvent('close');
</code>
Note, app window doesn&#8217;t need to know current state of the state machine.</li>
<li>The state machine itself is the one who creates/removes the timer which triggers timeout event. I am also thinking about moving this out of the state machine and do this in another mixin, only have the callback functions provided by the state machine. But I am not sure.</li>
<li>The state machine has some callback for others(other state machine!) listed below:

<ul>
<li>Enter a state successfully.</li>
<li>Leave a state successfully.</li>
<li>When an event triggers state switch successfully.
In all these callback we would get the previous state and current state, and the event who triggers them.</li>
</ul>
</li>
<li>The CSS class for real UI closing animation is added in <code><em>enterClosing</code> and removed in <code></em>enterClosed</code>. Or else we could do that in <code><em>leaveOpened</code> and <code></em>leaveClosing</code>. I have no strong opinion here.
Maybe we could define the level of the callback into three here, according to the callback order.</li>
<li>The CSS class for real UI opening animation is added in <code><em>enterOpening</code> and removed in <code></em>enterOpened</code>.</li>
<li>We could also move out (4) and (5) to another mixin to purify the state machine.</li>
</ol>


<p>Finally, back to the problems addressed in Tim&#8217;s article:</p>

<ul>
<li>Do we need intermediate state?

<ul>
<li>I don&#8217;t think so, at least for now. If we really need to goto next state when we successfully from state A to state B, we could call <code>_processEvent</code> again in the inner callback of the state machine. This doesn&#8217;t violate the policy that only state machine ifself could decide its next state.</li>
<li>If the intermediate state needs to acquire other type of state &#8211; just fetch the current state of the other state machine. Or, if we need, register an one-time callback if the current state doesn&#8217;t meet our requirement.</li>
</ul>
</li>
<li>How about state conflict between two apps?

<ul>
<li>That won&#8217;t happen if we deal with the state changes correctly and independently in each app&#8217;s scope. I hope so.</li>
</ul>
</li>
</ul>

</div>
  
  


</div>

      </article>
    
    
      <article class="span4">
        <div class="article-format">

  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/05/page-visibility-on-firefox-os/">HTML5 Page Visibility on Fx OS</a></h1>
    
    
      <p class="meta">
        
  


  
    <span class="byline author vcard">by <span class="fn">Alive Kuo</span></span>
  

 - 
        








  


<time datetime="2013-07-05T04:23:00+08:00" pubdate data-updated="true">Jul 5<span>th</span>, 2013</time> - 
        

posted in
<span class="categories">
  
    <a class='category' href='/blog/categories/firefoxos/'>firefoxos</a>
  
</span>


        
      </p>
    
  </header>


  <div class="entry-content"><p>在桌面版本的網頁開發中，我們可以透過 HTML5 的 page visibility API 來知道目前的網頁是否為使用者焦點，或者目前不可為使用者所見，來達成某些目的：如停止 UI 更新，資料交換&#8230;等，範例程式如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">handleVisibilityChange</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">hidden</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// Pause UI update</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// Begin UI update</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;visibilitychange&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">handleVisibilityChange</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>我們將這個 API 帶到 Firefox OS 中，並賦予了它更深一層的意義：</p>

<blockquote><p>應用程式判斷自己在前景/背景的依據，類似 android 的 onPause/onResume<br/>系統底層 Low Memory Killer 的參數之一：背景應用程式在可用記憶體過低時會優先被 kill<br/>在電力消耗變成一個必須優先考量要點的手持裝置上，透過進入背景時停止更新 UI 對電力節約有很大幅度的幫助。<br/>然而，在手機系統上，並不像在桌面瀏覽器一樣單純的是透過頁面切換 (onPageShow/onPageHide) 來決定要不要對某個 web page/app 做前景背景切換，而是要根據系統 UI hierarchy 以及當前介面中層級較高的其他元件的狀態來維持 visibility 的協調性。</p></blockquote>


<p>聽起來很抽象嗎？先來張系統模組介面架構圖：
<img src="http://i.imgur.com/ypJSsQg.jpg">
Gaia System Architecture Diagram (source from https://docs.google.com/drawings/d/18DnhTgQBK3M0KBeLGJkWW1hfiYBB6GgTmfdbUnT2SLs/edit?usp=sharing)</p>

<p>簡單的說，手機系統介面在特定狀態下會將目前已經是前景的 app 設定為背景狀態，其優先層級如下：</p>

<ol>
<li>Screen off (螢幕關閉)</li>
<li>Call screen (電話中介面)</li>
<li>Lockscreen on (手機鎖定介面啟動)</li>
<li>Inline activities (app內嵌 web activities 作用中)</li>
<li>App transition end (app 切換結束)</li>
<li>Back to home (回到 homescreen)</li>
</ol>


<p>而這些事件又可能會同時發生而產生互相影響，如：inline activity 作用時電話打進來，多重 inline activities 中第一次產生的 activity frame 會被第二次的 activity frame 蓋掉&#8230;等。</p>

<p>這些決策發生在哪呢？與桌面瀏覽器不同，決定這一切的是發生在 Gaia，也就是 Firefox OS 的 UI 層：換句話說，是以 JavaScript 撰寫的噢。而實現的方式是系統中各個模組對各個底層 moz-*  API 的 callback 重新包覆並以 custom event 的形式通知其他模組，最後集中給 system app 中的 Window Manager 來做統一管理。</p>

<p>這樣做最大的原因是：只有 Gaia 本身最了解與 UI 相關的一切，而既然 Gecko 將 API expose 出來，只要你對 API 夠熟悉，想要自己用 JavaScript/HTML 實現一個瀏覽器是可能的。</p>

<p>這部份我們可以用一個實例說明：
「裝置從進入閒置狀態，到使用者按下電源鍵，之後解開鎖定螢幕 (LockScreen)」對 visibility 影響的過程：</p>

<h5>Screen is off by idle timeout:</h5>

<ul>
<li>(Gaia) [Screen Manager] mozPower.screenEnabled = false</li>
<li>(Gaia) [Screen Manager] send custom &#8216;screenchange&#8217; event</li>
<li>(Gaia) [Lockscreen] get &#8216;screenchange&#8217; event, check the settings of &#8220;lockscreen.enabled&#8221; and dispatch custom &#8216;lock&#8217; event</li>
<li>(Gaia) [Window Manager] get &#8216;lock&#8217; event, and then set visibility = false for current app(focused one).</li>
<li>(Gonk) [/sys/power] See mozPower.screenEnabled is modified and send &#8216;sizemodechange&#8217; to simulate the content window is minimized.</li>
<li>(Gecko) [shell] Get &#8216;sizemodechange&#8217; event, set visibility = false for the whole system app</li>
</ul>


<h5>Turn on screen:</h5>

<ul>
<li>(Gecko) Get keypress event of sleep-button, and then send mozChromeEvent to gaia</li>
<li>(Gaia) [Hardware Button Manager] Get mozChromeEvent with type = &#8220;sleep-button-press&#8221;, wrap the event to &#8216;wake&#8217; event</li>
<li>(Gaia) [Screen Manager] mozPower.screenEnabled = true</li>
<li>(Gecko) [shell] Get &#8216;sizemodechange&#8217; event, set visibility = true for the whole system app
[NOTE] the current app is still invisible now, but the system app is visible.</li>
</ul>


<h5>Unlock the lockscreen:</h5>

<ul>
<li>(Gaia) [Lockscreen] Send custom &#8216;unlock&#8217; event.</li>
<li>(Gaia) [Widow Manager] Get &#8216;unlock&#8217; event and turn on the active app&#8217;s visibility.</li>
</ul>


<p>對 App 開發者來說，其實你只要適當地註冊 visibilitychange event handler 去分別處理前景與背景的任務，而維持 visibility state 的正確性與一致性則是作業系統的責任，這也是開發 website/web application 與 web-based OS 之間最大的不同吧：必須同時考慮到過去（已經存在的網頁）/現在（我們正在開發中的內建app）/未來（即將到來的 FirefoxOS app）。</p>

<p>P.S. This is posted at moztech first. See <a href="http://tech.mozilla.com.tw/posts/2020/visibility-api-on-firefox-os-%E5%BE%9E%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F%E5%89%8D%E8%83%8C%E6%99%AF%E6%8E%A7%E5%88%B6%E7%9C%8B-os-%E5%AF%A6%E4%BD%9C">here</a></p>
</div>
  
  


</div>

      </article>
    
    
      <article class="span4">
        <div class="article-format">

  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/05/one-year-at-mozilla/">My First Year at Mozilla</a></h1>
    
    
      <p class="meta">
        
  


  
    <span class="byline author vcard">by <span class="fn">Alive Kuo</span></span>
  

 - 
        








  


<time datetime="2013-07-05T02:31:00+08:00" pubdate data-updated="true">Jul 5<span>th</span>, 2013</time> - 
        

posted in
<span class="categories">
  
    <a class='category' href='/blog/categories/mozilla/'>mozilla</a>
  
</span>


        
      </p>
    
  </header>


  <div class="entry-content"><h3>Achievements</h3>

<ul>
<li>第一次出國，第一次出差。</li>
<li>工作關係出差四次去了三個國家（美國兩次，德國，西班牙），自己自助旅行去了日本。</li>
<li><a href="https://wiki.mozilla.org/Modules/FirefoxOS#System">變成module peer</a>。</li>
<li>參與了一些以前沒有被發明過的WebAPI的設計或討論。</li>
<li>有了當面試官的經驗。</li>
<li>第一次參加全公司的出遊活動。</li>
<li>對Firefox的layout engine: Gecko送了幾次patch，<a href="http://www.mozilla.org/hacking/committer/">簽了Level 1 Committer賣身契</a>。</li>
<li>寫了數百個各種patch，解了數百個各種bug。</li>
<li>看到很多以前沒有遇過的pattern，現在回去看一年前寫的東西感覺又不同了。</li>
<li>當然也看到一些不好的設計，很希望有機會能夠改變它。</li>
<li>認識一些除了我之外在工作之餘還是對技術玩意很有熱忱的人。</li>
<li>目前身分是自由球員，理論上被允許去做任何我想做的事，不太被干涉，我非常，非常喜歡這件事。也很感謝我的主管&#8221;縱容&#8221;我。</li>
<li>養了叫bug的貓。<img src="http://i.imgur.com/JPR0wzu.jpg"></li>
<li><a href="http://coscup.org/2012/en/program/">在COSCUP 2012給過talk</a>。</li>
<li><a href="http://coscup.org/2013/zh-tw/program/">今年還有一次跟FxOS有關的talk</a>。</li>
<li>在柏林的時候人生第一次看到雪。<img src="http://i.imgur.com/ffpaudD.jpg"></li>
</ul>


<h3>Canvas</h3>

<h4>MountainView</h4>

<p><img src="http://i.imgur.com/V1mXfJf.jpg">
<img src="http://i.imgur.com/ytFnxpi.jpg">
<img src="http://i.imgur.com/pCGMHcF.jpg"></p>

<h4>San Francisco</h4>

<p><img src="http://i.imgur.com/2WElJM1.jpg">
<img src="http://i.imgur.com/OBv99Ty.jpg">
<img src="http://i.imgur.com/7u3g8IC.jpg"></p>

<h4>Berlin - Snow!</h4>

<p><img src="http://i.imgur.com/cO74ubC.jpg">
<img src="http://i.imgur.com/EULi3MV.jpg">
<img src="http://i.imgur.com/tSer20f.jpg">
<img src="http://i.imgur.com/FEtE2wg.jpg"></p>

<h4>Spain</h4>

<p><img src="http://i.imgur.com/eufuWlp.jpg">
<img src="http://i.imgur.com/tbjIL9m.jpg">
<img src="http://i.imgur.com/GkWfumD.jpg">
<img src="http://i.imgur.com/v8Y3472.jpg"></p>

<h4>Japan</h4>

<ul>
<li>自助旅行 - 是的，這其實跟工作無關，不過也因為是在這裡，請長假出國玩絕對不是太困難的事情。</li>
<li>我在日本期間去了日本Mozilla辦公室 - 位在六本木，一個很棒的空間。
<img src="http://i.imgur.com/z4ekB4W.jpg">
<img src="http://i.imgur.com/2ErLpTd.jpg">
<img src="http://i.imgur.com/qtQGJuH.jpg">
<img src="http://i.imgur.com/BTRD67c.jpg">
<img src="http://i.imgur.com/q27j5yp.jpg"></li>
</ul>


<h3>While (true) {</h3>

<ul>
<li>還想多用javascript寫一些不同的pattern。</li>
<li>想培養持續玩一些小的side probject的習慣。</li>
<li>想把自己bug track list裡面的bug通通吃完。</li>
<li>想了解gaia裡面某些至今還沒有看完的複雜的應用做了什麼，為了什麼，可以學到什麼。</li>
<li>繼續寫blog吧!</li>
<li>想改變我想改變的事情。

<h3>}</h3></li>
</ul>

</div>
  
  


</div>

      </article>
    
    
      <article class="span4">
        <div class="article-format">

  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/06/18/alvitr/">Recent Side Projects: Alvitr, Lucifer, GaiaSystemAPIDOC</a></h1>
    
    
      <p class="meta">
        
  


  
    <span class="byline author vcard">by <span class="fn">Alive Kuo</span></span>
  

 - 
        








  


<time datetime="2013-06-18T12:33:00+08:00" pubdate data-updated="true">Jun 18<span>th</span>, 2013</time> - 
        

posted in
<span class="categories">
  
    <a class='category' href='/blog/categories/github-javascript/'>github,javascript</a>
  
</span>


        
      </p>
    
  </header>


  <div class="entry-content"><h3>Alvitr</h3>

<p>Alvitr(艾爾薇妲）是北歐神話中戰女神的其中一名，其名意為「全知」。</p>

<p>最近對某個遊戲(Puzzle &amp; Dragon)很沉迷，
但是在網路上遍尋不著產生簽名檔的服務，
於是就興起了想要自己做的念頭。</p>

<p><a href="http://alivedise.github.io/alvitr">Alvitr</a></p>

<p>大概花了一個禮拜的時間，本來想用Amazon AWS + node.js的組合來用伺服器端產生圖檔，
但是遇到了不少問題如：
1. AWS初始化實在太煩人了。
2. node.js跑起來會莫名的crash，錯誤訊息看起來像是c語言的某個函式。（我不是在寫js嗎？！)</p>

<p>後來還是決定用client端javascript application的形式做，
至少IE9可以支援Canvas。</p>

<h4>Canvas templating</h4>

<p>因為目標是把使用者輸入的資料轉成不同大小內容配置也不同的圖片，</p>

<p>於是我在想可以針對不同大小圖片弄一個像是configurtaion的物件，每次配置選擇改變只要換掉configuration就好了。</p>

<p>最後成果<a href="https://github.com/alivedise/alvitr/blob/gh-pages/javascripts/client.js">client.js</a></p>

<p>繪圖元件配置不外乎：x, y, weight, height, color等的參數，所以要創造一個新的配置物件只要複製貼上再去微調就好了。</p>

<h3>Lucifer</h3>

<blockquote><p>明亮之星，早晨之子啊，你何竟從天墜落？你這攻敗列國的何竟被砍倒在地上？你心裡曾說：我要升到天上；我要高舉我的寶座在神眾星以上；我要坐在聚會的山上，在北方的極處。我要升到高雲之上；我要與至上者同等。然而，你必墜落陰間，到坑中極深之處。</p></blockquote>


<p><a href="http://alivedise.github.io/lucifer">Lucifer</a></p>

<p>拿某篇文章來開的小玩笑，主要是用了ejs template engine來亂數產生一些怪物資料在文章內。</p>

<h3>Gaia System API Documentation</h3>

<p><a href="http://alivedise.github.io/gaia-system-jsdoc/">Gaia System JSDOC</a>
<a href="https://github.com/alivedise/jsdoc3-bootstrap">JSDOC3 bootstrap template</a>
不知道為什麼jsdoc2我電腦一直裝不成功，jsdoc3倒是很簡單的用npm就裝好了。</p>

<p>找了一下找不到專門給jsdoc3用的好看template&#8230;我就自己套bootstrap上去了，成果如上。</p>

<h3>其他</h3>

<p>我還有一兩個一直很想做的probject&#8230;不過總是因為懶惰作罷:P</p>

<p>回首到Mozilla也一年了，感覺自身還有很多不足&#8230;.
督促自己寫side project只是開始而已，還要再努力阿！</p>
</div>
  
  


</div>

      </article>
    
    
      <article class="span4">
        <div class="article-format">

  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/05/27/rotation-matrix/">Javascript從變形矩陣反推scale以及rotate</a></h1>
    
    
      <p class="meta">
        
  


  
    <span class="byline author vcard">by <span class="fn">Alive Kuo</span></span>
  

 - 
        








  


<time datetime="2013-05-27T15:41:00+08:00" pubdate data-updated="true">May 27<span>th</span>, 2013</time> - 
        

posted in
<span class="categories">
  
    <a class='category' href='/blog/categories/javascript/'>javascript</a>
  
</span>


        
      </p>
    
  </header>


  <div class="entry-content"><p>原文：
<a href="http://css-tricks.com/get-value-of-css-rotation-through-javascript/">http://css-tricks.com/get-value-of-css-rotation-through-javascript/</a></p>

<p>今天在追一個跟CSS3 transform有關的bug，
過程中懷疑是transform沒有正確應用到element上。</p>

<p>最後想到用一個Mutation Observer去觀察元素的變形矩陣的某個值（在此例為scale)的變化，
因為transform沒辦法直接用element.style直接拿到scale的值，
所以要用getComputedStyle拿出變形矩陣後算出來：
（skew跟translate的值原文沒有提供算法，看了一下網路文章似乎沒辦法逆推。）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Construct a mutation observer.</span>
</span><span class='line'><span class="cm">   * See https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * var target = document.querySelector(&#39;#id&#39;);</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#id&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * create an observer instance</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">observer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MutationObserver</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">mutations</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * We could iterate the mutations here,</span>
</span><span class='line'><span class="cm">     * but I don&#39;t really care it now.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">st</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">getComputedStyle</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">tr</span> <span class="o">=</span> <span class="nx">st</span><span class="p">.</span><span class="nx">getPropertyValue</span><span class="p">(</span><span class="s2">&quot;-webkit-transform&quot;</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>             <span class="nx">st</span><span class="p">.</span><span class="nx">getPropertyValue</span><span class="p">(</span><span class="s2">&quot;-moz-transform&quot;</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>             <span class="nx">st</span><span class="p">.</span><span class="nx">getPropertyValue</span><span class="p">(</span><span class="s2">&quot;-ms-transform&quot;</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>             <span class="nx">st</span><span class="p">.</span><span class="nx">getPropertyValue</span><span class="p">(</span><span class="s2">&quot;-o-transform&quot;</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>             <span class="nx">st</span><span class="p">.</span><span class="nx">getPropertyValue</span><span class="p">(</span><span class="s2">&quot;transform&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Matrix: &#39;</span> <span class="o">+</span> <span class="nx">tr</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// rotation matrix - http://en.wikipedia.org/wiki/Rotation_matrix</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="nx">tr</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'>    <span class="nx">values</span> <span class="o">=</span> <span class="nx">values</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>    <span class="nx">values</span> <span class="o">=</span> <span class="nx">values</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">values</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">values</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">values</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">values</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">scale</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">a</span><span class="o">*</span><span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="o">*</span><span class="nx">b</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// arc sin, convert from radians to degrees, round</span>
</span><span class='line'>    <span class="c1">// DO NOT USE: see update below</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">sin</span> <span class="o">=</span> <span class="nx">b</span><span class="o">/</span><span class="nx">scale</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">angle</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">asin</span><span class="p">(</span><span class="nx">sin</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">180</span><span class="o">/</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// works!</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Scale: &#39;</span> <span class="o">+</span> <span class="nx">scale</span> <span class="o">+</span> <span class="s1">&#39;;Rotate: &#39;</span> <span class="o">+</span> <span class="nx">angle</span> <span class="o">+</span> <span class="s1">&#39;deg&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">    * Configuration of mutation observer.</span>
</span><span class='line'><span class="cm">    */</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">attributes</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">childList</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">characterData</span><span class="o">:</span> <span class="kc">true</span> <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * pass in the target node, as well as the observer options</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="nx">observer</span><span class="p">.</span><span class="nx">observe</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">config</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


</div>

      </article>
    
    
      <article class="span4">
        <div class="article-format">

  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/23/from-browser-to-browser/">From Browser to Browser. (1)</a></h1>
    
    
      <p class="meta">
        
  


  
    <span class="byline author vcard">by <span class="fn">Alive Kuo</span></span>
  

 - 
        








  


<time datetime="2013-02-23T17:40:00+08:00" pubdate data-updated="true">Feb 23<span>rd</span>, 2013</time> - 
        

posted in
<span class="categories">
  
    <a class='category' href='/blog/categories/gaia/'>gaia</a>
  
</span>


        
      </p>
    
  </header>


  <div class="entry-content"><h3>Firefox OS</h3>

<p><img src="http://cdn0.mos.techradar.futurecdn.net///art/mobile_phones/Mozilla/FireFoxOS/DeveloperHandsets/FirefoxOSDev-Press-01-580-75.jpg"></p>

<h3>System app</h3>

<p>Exactly, Firefox OS, also known for boot 2 gecko, is having only one app/one page.
It&#8217;s the system app, which controls all web app&#8217;s life cycle.
When FirefoxOS is booted, it would load the system app from <code>system/index.html</code>.
Then system app would take care of the remaing stuff.</p>

<ul>
<li>Load modules</li>
<li>Init homescreen app</li>
<li>Etc.</li>
</ul>


<h3>Window Manager</h3>

<p>Window Manager is the core of Firefox OS, the core of system app, which is in charge of creating/maintaining/killing apps.
An app, indeed, is a web page.</p>

<p>We use a magic, calling browser API, to make a web page act like an app.</p>

<h3>Browser API</h3>

<p>See https://developer.mozilla.org/en-US/docs/DOM/Using_the_Browser_API</p>

<p>A browser here means that the web page acts like it is living in a browser <code>frame</code>.
We are replacing nearly every XUL-based UI with HTML to <code>port</code> the WEB to the phone.</p>

<h3>Module Pattern</h3>

<p>Module pattern is the way Window Manager being imeplemented.
A module pattern looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">WindowManager</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">_running</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">createApp</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>     <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">();</span>
</span><span class='line'>     <span class="nx">_running</span><span class="p">[</span><span class="nx">_id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">app</span><span class="p">;</span>
</span><span class='line'>     <span class="nx">_id</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>     <span class="k">return</span> <span class="nx">app</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">killApp</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">delete</span> <span class="nx">_running</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">create</span><span class="o">:</span> <span class="nx">createApp</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">kill</span><span class="o">:</span> <span class="nx">killApp</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">})();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Thus the Window Manager object only has 2 public attributes.
This looks fine, but it would be a nightmare if this pattern grows to over 2000 lines.
And it&#8217;s having countless private functions now.</p>

<p>This module now is not unit testable nor maintainable.</p>

<h3>Break it!</h3>

<h4>From the browser to the browser</h4>

<p>Let&#8217;s define a new object to contain and manage itself in its own scope.</p>

<p>It&#8217;s called <code>browserFrame</code>.</p>

<h5>The responsibility of browserFrame</h5>

<p>It would create an iframe with all attributes needed for BrowserAPI.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* Define a basic mozbrowser iframe class.</span>
</span><span class='line'><span class="cm"> * It creates a mozbrowser iframe,</span>
</span><span class='line'><span class="cm"> * and finally returns the DOM element it just created.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">BrowserFrame</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="nx">invocation</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">BrowserFrame</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// This constructor function is a local variable.</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">element</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">nextId</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">callbacks</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>    <span class="nx">createFrame</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="c1">// All arguments are values to createFrame</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">BrowserFrame</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">&#39;browser&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// These are helper functions and variables used by the methods above</span>
</span><span class='line'>  <span class="c1">// They&#39;re not part of the public API of the module, but they&#39;re hidden</span>
</span><span class='line'>  <span class="c1">// within this function scope so we don&#39;t have to define them as a</span>
</span><span class='line'>  <span class="c1">// property of Browser or prefix them with underscores.</span>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">createFrame</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">origin</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">manifestURL</span><span class="p">,</span> <span class="nx">oop</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">browser</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;iframe&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">browser</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;mozallowfullscreen&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Most apps currently need to be hosted in a special &#39;mozbrowser&#39; iframe.</span>
</span><span class='line'>    <span class="c1">// They also need to be marked as &#39;mozapp&#39; to be recognized as apps by the</span>
</span><span class='line'>    <span class="c1">// platform.</span>
</span><span class='line'>    <span class="nx">browser</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;mozbrowser&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">oop</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">browser</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;remote&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">manifestURL</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">browser</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;mozapp&#39;</span><span class="p">,</span> <span class="nx">manifestURL</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">origin</span><span class="p">)</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">origin</span> <span class="o">=</span> <span class="nx">origin</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">browser</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">browser</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">className</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">browser</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">BrowserFrame</span><span class="p">.</span><span class="nx">className</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Store the element</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">element</span> <span class="o">=</span> <span class="nx">browser</span><span class="p">;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">nextId</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="c1">// The public API for this module is the Browser() constructor function.</span>
</span><span class='line'>  <span class="c1">// We need to export that function from this private namespace so that</span>
</span><span class='line'>  <span class="c1">// it can be used on the outside. In this case, we export the constructor</span>
</span><span class='line'>  <span class="c1">// by returning it. It becomes the value of the assignment expression</span>
</span><span class='line'>  <span class="c1">// on the first line above.</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">BrowserFrame</span><span class="p">;</span>
</span><span class='line'><span class="p">}());</span> <span class="c1">// Invoke the function immediately after defining it.</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


</div>

      </article>
    
    
      <article class="span4">
        <div class="article-format">

  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/23/mock-moz-activity/">Mocha: MockMozActivity與global Leak</a></h1>
    
    
      <p class="meta">
        
  


  
    <span class="byline author vcard">by <span class="fn">Alive Kuo</span></span>
  

 - 
        








  


<time datetime="2013-02-23T16:56:00+08:00" pubdate data-updated="true">Feb 23<span>rd</span>, 2013</time> - 
        

posted in
<span class="categories">
  
    <a class='category' href='/blog/categories/javascript/'>javascript</a>
  
</span>


        
      </p>
    
  </header>


  <div class="entry-content"><p>之前在寫單元測試時，需要測到MozActivity的呼叫。</p>

<p>當我們嘗試去取代window object中的MozActivity時，會遇到：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0) Feed "before all" hook: Error: global leak detected:</span></code></pre></td></tr></table></div></figure>


<p>解決方法：</p>

<p>在程式前面加上<code>mocha.setup({ignoreLeaks: true});</code></p>

<p>最後加上<code>mocha.setup({ignoreLeaks: true});</code></p>

<p>碰到這個錯誤是在嘗試加入假的MozActivity給window時。</p>

<p>因為要被測試的module中有如下的程式片段：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'>  <span class="k">new</span> <span class="nx">MozActivity</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;view&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">data</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="nx">url</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>去呼叫browser app開啟某個特定網頁，</p>

<p>但是mocha跑的環境中有可能：</p>

<ol>
<li>並沒有window.MozActivity這個物件。</li>
<li>有MozActivity但是我們無法知道他是否被呼叫。</li>
</ol>


<p>這時候需要塞一個MockMozActivity給window，暫時取代掉原本的MozActivity，</p>

<p>然後從MockMozActivity裡面留個變數記錄被呼叫的參數狀況來判斷程式是否正確的執行呼叫activity。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">mockMozActivityInstance</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">MockMozActivity</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">MozActivity</span><span class="p">(</span><span class="nx">configuration</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">property</span> <span class="k">in</span> <span class="nx">configuration</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">=</span> <span class="nx">configuration</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">mockMozActivityInstance</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>之後寫的測試內容：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// Captive Portal Test</span>
</span><span class='line'>  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;system/captive portal login w/o manual enable wifi&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">CaptivePortal</span><span class="p">.</span><span class="nx">handleEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">MockSettingsListener</span><span class="p">.</span><span class="nx">mCallback</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">mockMozActivityInstance</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s1">&#39;view&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>人生第一個單元測試程式完成 \O/</p>
</div>
  
  


</div>

      </article>
    
    
      <article class="span4">
        <div class="article-format">

  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/12/22/javascript-memorization/">Javascript Memorization</a></h1>
    
    
      <p class="meta">
        
  


  
    <span class="byline author vcard">by <span class="fn">Alive Kuo</span></span>
  

 - 
        








  


<time datetime="2012-12-22T00:28:00+08:00" pubdate data-updated="true">Dec 22<span>nd</span>, 2012</time> - 
        

posted in
<span class="categories">
  
    <a class='category' href='/blog/categories/javascript/'>javascript</a>
  
</span>


        
      </p>
    
  </header>


  <div class="entry-content"><p>As you know, function in javascript is also an object,
you could use a property of the object to keep function result.
This is called <code>Memorization</code>.</p>

<p>Today I have a chance to utilize this skill.</p>

<p>Please read codes below first:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">getOffOrigin</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">frame</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">url</span> <span class="o">?</span> <span class="nx">app</span><span class="p">.</span><span class="nx">frame</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">url</span> <span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">frame</span><span class="p">.</span><span class="nx">src</span><span class="p">,</span> <span class="nx">origin</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">subtitle</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">subtitle</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">getOffOrigin</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">frame</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">url</span> <span class="o">?</span> <span class="nx">app</span><span class="p">.</span><span class="nx">frame</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">url</span> <span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">frame</span><span class="p">.</span><span class="nx">src</span><span class="p">,</span> <span class="nx">origin</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">card</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">subtitle</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>getOffOrigin</code> has to use some logic to compare the two arguments and return a string.
The result wouldn&#8217;t change if the arguments are the same.
Therefore, to avoid calling the function many times, the result could be stored in the function itself.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="kd">function</span> <span class="nx">getOffOrigin</span><span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="nx">origin</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Use src and origin as cache key</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">cacheKey</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">));</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">getOffOrigin</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">cacheKey</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="kr">native</span> <span class="o">=</span> <span class="nx">getOriginObject</span><span class="p">(</span><span class="nx">origin</span><span class="p">);</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">getOriginObject</span><span class="p">(</span><span class="nx">src</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">current</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">==</span> <span class="s1">&#39;http:&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Display http:// protocol anyway</span>
</span><span class='line'>        <span class="nx">getOffOrigin</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">cacheKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">+</span> <span class="s1">&#39;//&#39;</span> <span class="o">+</span> <span class="nx">current</span><span class="p">.</span><span class="nx">hostname</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="kr">native</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">==</span> <span class="nx">current</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>          <span class="kr">native</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">==</span> <span class="nx">current</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>          <span class="kr">native</span><span class="p">.</span><span class="nx">port</span> <span class="o">==</span> <span class="nx">current</span><span class="p">.</span><span class="nx">port</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Same origin policy</span>
</span><span class='line'>        <span class="nx">getOffOrigin</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">cacheKey</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">current</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">==</span> <span class="s1">&#39;app:&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Avoid displaying app:// protocol</span>
</span><span class='line'>        <span class="nx">getOffOrigin</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">cacheKey</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">getOffOrigin</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">cacheKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">+</span> <span class="s1">&#39;//&#39;</span> <span class="o">+</span> <span class="nx">current</span><span class="p">.</span><span class="nx">hostname</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nx">getOffOrigin</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">cacheKey</span><span class="p">];</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">getOffOrigin</span><span class="p">.</span><span class="nx">cache</span> <span class="o">=</span> <span class="p">{};</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><p>If we only have one arguments we could use it as the key to cache directly.
But we have multiple arguments in this case, we then use stringilized JSON to be the key.</p></li>
<li><p>Hence we don&#8217;t need to do the same thing every time we enter this function if the arguments are used before.</p></li>
<li><p>Have fun with your function cache!</p></li>
</ul>

</div>
  
  


</div>

      </article>
    
    </div>
      <div class="row">
        <ul class="pager">
          
            <li class="previous">
              <a href="/blog/page/2/">&larr; Older</a>
            </li>
          
          
        </ul>
      </div>
  </div>
</div>


  <div id="footer-widgets">
  <div class="container">
    <div class="row">
  <div class="span3">
    <h2>recent posts</h2>
    <ul class="recent_posts">
      
        <li>
          <a href="/blog/2013/07/16/audio-competing-in-fxos/">[Fx OS] Background media play</a>
        </li>
      
        <li>
          <a href="/blog/2013/07/10/system-modulization-plan/">Proposal: System Modulization Plan</a>
        </li>
      
        <li>
          <a href="/blog/2013/07/05/transition-state-machine/">[Window Management] Transition state machine</a>
        </li>
      
        <li>
          <a href="/blog/2013/07/05/page-visibility-on-firefox-os/">HTML5 Page visibility on Fx OS</a>
        </li>
      
        <li>
          <a href="/blog/2013/07/05/one-year-at-mozilla/">My first year at Mozilla</a>
        </li>
      
    </ul>
    <h2><a href="/blog/archives">archives</a></h2>
  </div>
  <div class="span3">
    

  </div>
  <div class="span4">
    
<h2>twitter</h2>
<a href="https://twitter.com/alivedise" class="twitter-follow-button" data-show-count="true" data-lang="en">Follow @alivedise</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
<div class="tweet" data-twitter-user="alivedise">
</div>


  </div>
  <div class="span2">
    <h2>found on</h2>

<a href="https://github.com/alivedise/" rel="tooltip" title="Github"><img class="social_icon" title="Github" alt="github icon" src="/images/glyphicons_381_github.png"></a>







<a href="http://twitter.com/alivedise" rel="tooltip" title="Twitter"><img class="social_icon" title="Twitter" alt="Twitter icon" src="/images/glyphicons_391_twitter_t.png"></a>








  </div>
</div>

  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-left">
  <a href="/">Ascheriit</a>
  - Copyright &copy; 2013 - Alive Kuo
</p>
<p class="pull-right">
  <span>Powered by <a href="http://octopress.org/">Octopress</a>.</span>
  
    <span>Designed by <a href="http://www.AdrianArtiles.com">Adrian Artiles</a>.</span>
  
</p>

  </div>
</footer>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<script>window.jQuery || document.write('<script src="/javascripts/libs/jquery-1.7.2.min.js" type="text/javascript"><\/script>')</script>
<script src="/javascripts/libs/bootstrap.min.js" type="text/javascript"></script>
<script src="/javascripts/jquery.tweet.js" type="text/javascript"></script>
<script src="/javascripts/jquery.instagram.js" type="text/javascript"></script>
<script src="/javascripts/libs/jquery.masonry.min.js" type="text/javascript"></script>
<script src="/javascripts/custom.js" type="text/javascript"></script>


<script type="text/javascript">
      var disqus_shortname = 'ascheriit';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




</body>
</html>
