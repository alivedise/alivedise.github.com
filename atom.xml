<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Ascheriit]]></title>
  <link href="http://alivedise.github.io/atom.xml" rel="self"/>
  <link href="http://alivedise.github.io/"/>
  <updated>2013-12-16T10:33:04+08:00</updated>
  <id>http://alivedise.github.io/</id>
  <author>
    <name><![CDATA[Alive Kuo]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Migrated to logdown]]></title>
    <link href="http://alivedise.github.io/blog/2013/12/16/logdown/"/>
    <updated>2013-12-16T10:30:00+08:00</updated>
    <id>http://alivedise.github.io/blog/2013/12/16/logdown</id>
    <content type="html"><![CDATA[<p>Octopress 雖然很棒但是每次換環境都要重弄實在太麻煩了，
所以我偷偷的轉移到 logdown 一段時間了。</p>

<p><a href="http://alivedise.logdown.com">http://alivedise.logdown.com</a></p>

<p>Welcome to visit!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[COSCUP 2013] Audio competing in FxOS]]></title>
    <link href="http://alivedise.github.io/blog/2013/08/06/coscup-2013/"/>
    <updated>2013-08-06T17:40:00+08:00</updated>
    <id>http://alivedise.github.io/blog/2013/08/06/coscup-2013</id>
    <content type="html"><![CDATA[<p>I gave a presentation about how we implement the audio competing in FxOS in COSCUP.</p>

<script async="true" class="speakerdeck-embed" data-id="fbfe96a0e1390130ff014239028c3727" src="http://alivedise.github.io//speakerdeck.com/assets/embed.js"> </script>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[FxOS] Plan: Window Management decoupling (CONT.)]]></title>
    <link href="http://alivedise.github.io/blog/2013/07/18/window-manager-decoupling/"/>
    <updated>2013-07-18T17:33:00+08:00</updated>
    <id>http://alivedise.github.io/blog/2013/07/18/window-manager-decoupling</id>
    <content type="html"><![CDATA[<p>Following are the plan about why and how to split current Gaia:System:Window Manager.</p>

<h2>Sources/Links</h2>

<ul>
<li><a href="https://github.com/mozilla-b2g/gaia/blob/master/apps/system/js/window_manager.js">Window Manager source</a></li>
<li><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=845251">Window Manager testable meta bug</a></li>
</ul>


<h2>Current main functions in Window Manager</h2>

<ul>
<li>App Window Management</li>
<li>Wrapper Window Management</li>
<li>Inline Activity Management</li>
<li>Homescreen Management</li>
<li>MozBrowser Element Generation</li>
<li>Orientation Management</li>
<li>Visibility Management</li>
<li>Resize Management</li>
<li>App Screenshots Management [deprecated]</li>
<li>System Message Handler</li>
<li>Open app transition</li>
<li>Close app transition</li>
<li>FTU Management [deprecated! Become standalone FTU Launcher already!]</li>
</ul>


<p>So which could be pulled out to reduce the heavy weight?</p>

<!--more-->


<h3>Inline Activity Management &ndash;> App Window</h3>

<p>Inline Activity Management should belong to the activity caller.</p>

<p>If app A opens a page(open.html) of app B as an inline activity,
the life cycle of activity callee is based on app A instead of app B.</p>

<p>Thus, if app A is killed or closed, the activity opened by app A should be killed.</p>

<p>But if app B(index.html) is killed, activity B(open.html) shouldn&rsquo;t be affected.</p>

<h3>Resize Management</h3>

<p>Resize is another duty of the app window instance itself.</p>

<p>If we&rsquo;re moving the activity into the app window, we could</p>

<ol>
<li>Recursively call current activity callee&rsquo;s resize function until the last callee is found.</li>
<li>Resize all activity callee on top of current app window.</li>
</ol>


<p>in the app window&rsquo;s resize function.</p>

<h3>Visibility Management</h3>

<p>App window would have 2 kind of &ldquo;child-like&rdquo; window instance:
* <code>var child = window.open</code>
* <code>Activity</code></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Fx OS] Background media play]]></title>
    <link href="http://alivedise.github.io/blog/2013/07/16/audio-competing-in-fxos/"/>
    <updated>2013-07-16T19:16:00+08:00</updated>
    <id>http://alivedise.github.io/blog/2013/07/16/audio-competing-in-fxos</id>
    <content type="html"><![CDATA[<p><img src="https://blog.mozilla.org/press/files/2012/09/FXOS_Music_Grid.jpg"></p>

<p>If you want to have you own media playing app to be able to run at background,
and/or has the ability to interrupt other playing audio, please view this article for what to do.</p>

<!--more-->


<h2>Audio Channel Permission</h2>

<p>You need to specify this permission in the manifest of your app.</p>

<p>And yes, this means we don&rsquo;t allow a web page without the manifest to play at background.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="s2">&quot;permissions&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;audio-channel-content&quot;</span><span class="o">:</span> <span class="p">{}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>content</code> represents the name of the audio channel.</p>

<p>Note: Video&rsquo;s permission also uses the same <code>audio-channel-content</code>.</p>

<h3>Audio Channel Types</h3>

<p>We have five audio channels currently:</p>

<ul>
<li><code>normal</code>: Default channel of any media element, including video.</li>
<li><code>content</code>: Especailly stands for content like music.</li>
<li><code>notification</code>: Include desktop-notification sounds</li>
<li><code>ringer</code>: Incoming call ringer</li>
<li><code>alarm</code>: Alarm has a specific requirement to interrupt any other channel above.</li>
<li><code>telephony</code>: Voice.</li>
</ul>


<h4>Volume Settings</h4>

<ul>
<li>Normal and content channel are sharing the same volume settings.</li>
<li>Notification and ringer are another set.</li>
<li>Other has its own settings key.</li>
</ul>


<h3>Audio Competing Rules</h3>

<ol>
<li>We&rsquo;re interrupting the lower channel when higher channel occurs.</li>
<li>If the same channel are playing and using content channel,
the one who gets visibility (go to foreground) would be the winner.</li>
<li>The foreground page/app is always playable. However the channel type decides it could interrupt background playing content or not.</li>
<li>The background page/app is playable if and only if the background is causing by screen off,
and the page/app is the current displayed one.</li>
</ol>


<p>I would explain the rules more in another article ;)</p>

<h2>[Statically] HTML Media Element</h2>

<p>You could assign audio channel type to the media elements in HTML.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;audio</span> <span class="na">mozaudiochannel=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;&lt;/audio&gt;</span>
</span><span class='line'><span class="nt">&lt;video</span> <span class="na">mozaudiochannel=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;&lt;/video&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Please keep in mind you need relevant channel permission.</p>

<blockquote><p>Note: It&#8217;s <code>mozaudiochannel</code> instead of <code>mozaudiopchanneltype</code> here.</p></blockquote>


<h2>[Dynamically] Javascript</h2>

<p>Sometimes we need to dynamically generate the player element:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">audio</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Audio</span><span class="p">();</span>
</span><span class='line'><span class="nx">audio</span><span class="p">.</span><span class="nx">mozAudioChannelType</span> <span class="o">=</span> <span class="s1">&#39;content&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Set audio channel type before setting src to avoid decoder confuses.</span>
</span><span class='line'><span class="nx">audio</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s1">&#39;xxx.ogg&#39;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Change the channel of the audio to another type is not allowed.</p>

<p>You should create another audio/video instance if you want to be played in another channel.</p>

<h2>(OPTIONAL) If you want to know you&rsquo;re interrupted by higher channel</h2>

<p>Add mozinterruptbegin/mozinterruptend event handler if you need to do something with interruptions.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'>  <span class="kd">var</span> <span class="nx">player</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;audio#my-player&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// ...</span>
</span><span class='line'>  <span class="c1">// The event is fired on the media element. </span>
</span><span class='line'>  <span class="nx">player</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;mozinterruptbegin&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">onInterrupted</span><span class="p">()</span> <span class="p">{</span><span class="c1">//do sth....}); </span>
</span><span class='line'>  <span class="nx">player</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;mozinterruptend&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">onResumed</span><span class="p">()</span> <span class="p">{</span><span class="c1">// do sth....}); </span>
</span></code></pre></td></tr></table></div></figure>


<h2>Notices</h2>

<ul>
<li>Even if your are developing a HTML5 video playing app,
and we all know that video shouldn&rsquo;t be played at background due to strange UX,
you should also consider to set content channel because video is expected to interrupt the current background playing media.</li>
</ul>


<h2>Reference</h2>

<ul>
<li><a href="https://wiki.mozilla.org/WebAPI/AudioChannels">Mozilla WIKI: Audio Channel</a></li>
<li><a href="https://groups.google.com/forum/?fromgroups=#!topic/mozilla.dev.gaia/HyAlHdFdX68">B2G Maillist</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Proposal: System Modulization Plan]]></title>
    <link href="http://alivedise.github.io/blog/2013/07/10/system-modulization-plan/"/>
    <updated>2013-07-10T18:04:00+08:00</updated>
    <id>http://alivedise.github.io/blog/2013/07/10/system-modulization-plan</id>
    <content type="html"><![CDATA[<h4>Source</h4>

<p><a href="https://github.com/mozilla-b2g/gaia/tree/master/apps/system">https://github.com/mozilla-b2g/gaia/tree/master/apps/system</a></p>

<h4>Issues with Modulization-less</h4>

<ol>
<li>Some modules directly invokes others.</li>
<li><code>&lsquo;LockScreen is undefined.&rsquo;</code> message appears oftenly right after device boots up.</li>
<li>Memory concern &ndash; Most of the modules are not always needed. Most of the UI view doesn&rsquo;t need to live in the DOM tree at first.</li>
<li>Performance concern &ndash; device bootup time is getting longer and longer.</li>
</ol>


<!--more-->


<h4>Proposal: Core modules and side modules</h4>

<p>We could figure out what&rsquo;s definitely necessary in an operating system and what&rsquo;s not.
For example, <code>Window Management</code> relevant modules should be a core module but <code>Captive Portal</code> shouldn&rsquo;t be.</p>

<p>The main idea is the same as any other app performanace tuning:
Lazy load anything on demand.</p>

<p>The key to this idea would be to establish the following rules:
* Any side module would have a main event by interest.
* An event dispatcher as a core module to gather all main events of side modules and then lazy load them.
For example, lazy load the Captive Portal:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;mozChromeEvent&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">detail</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;captive-portal-login&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">CaptivePortal</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">lazy</span><span class="o">-</span><span class="nx">load</span><span class="p">(</span><span class="s1">&#39;captive-portal&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">onReadyCallback</span><span class="p">()</span> <span class="p">{</span>   <span class="c1">// lazy load captive portal and its HTML part.</span>
</span><span class='line'>      <span class="nx">CaptivePortal</span><span class="p">.</span><span class="nx">handleEvent</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>  <span class="c1">// Pass the event</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>  <span class="c1">// If we have already load the CaptivePortal, the event listener inside CP would catch the event by itself.</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>So another rule would be:
* expose handleEvent in any side module for Event Dispatcher to invoke when they are firt time loaded by Event Dispatcher.</p>

<p>With this, we could even lazy load lockscreen,
because if lockscreen is disabled by the user, we don&rsquo;t need to load it when the device boots.</p>

<p>IMO there&rsquo;re only few core modules now:</p>

<ul>
<li>Window Management

<ul>
<li>App Window</li>
<li>Browser Frame</li>
</ul>
</li>
<li>Utility-tray</li>
<li>Statusbar</li>
<li>Init Logo Handler (But this is useless after device boot finishes.)</li>
<li>Screen Management (Exactly, it&rsquo;s indeed Wake Lock Management)</li>
<li>Applications (API Wrapper for mozApp)</li>
</ul>


<p>The following are API wrappers which I believe is also important enough to be a core module.</p>

<ul>
<li>Hardware Button Management (Many other modules&#8217; execution route is started here.)</li>
<li>Battery Management (UI-less but more like an API wrapper for mozBattery so I would put this into core module.)</li>
<li>Airplane Mode (API Wrapper of mozSettings: radio.enabled)</li>
<li>Bluetooth (API Wrapper for mozBluetooth)</li>
<li>Cost Control (It already lives inside an iframe.)</li>
<li>Ftu Launcher (Necessary only for one time when device is first time booted.)</li>
<li>Keyboard Management</li>
<li>mouse2touch</li>
<li>Notifications</li>
<li>Orientation observer (API Wrapper for deviceorientation event)</li>
<li>Sound manager (There are too many events involed here.)</li>
<li>Update Management</li>
</ul>


<h5>Chanllenge</h5>

<p>If we want to &ldquo;unload&rdquo; the module and its view using iframe,
we need a way for modules inside iframe to communicate.
The first thing come to my mind is <code>window.parent.postMessage</code></p>

<p>Second, we need to consider dependency problems if it&rsquo;s too complex.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Window Management] Transition state machine]]></title>
    <link href="http://alivedise.github.io/blog/2013/07/05/transition-state-machine/"/>
    <updated>2013-07-05T14:53:00+08:00</updated>
    <id>http://alivedise.github.io/blog/2013/07/05/transition-state-machine</id>
    <content type="html"><![CDATA[<p>The article is inspired by Tim&rsquo;s <a href="http://blog.timc.idv.tw/posts/css-classes-state-machine-puzzle/">CSS Classes State Machine Puzzle</a>.</p>

<p>We had some frustrations all the times, on animating a window correctly.</p>

<p>Recently I try to dedicate on solving the puzzle.
But at first I need to apologize for my poor knowledge and thought about css transitions using class names.</p>

<!--more-->


<p>In the past I usually thought it was stupid to use class list to control the style.
I thought it was ambiguous and strange if we ran into a situation that there&rsquo;re more than one classes of same type put on one element. And an element full of different class names for different purposes may conflict. Recently I see <a href="https://github.com/h5bp/Effeckt.css">Effeckt</a> and know this is the trend: a simple class name stands for a kind of animation.</p>

<p>The real problem is that we should never put wrong class on the DOM element, in javascript. So this now turns to be a pure javascript puzzle.</p>

<p>We know, that, in certain moment, the app window is always in a specific state A, not B nor C. So what&rsquo;s the problem? It&rsquo;s how could we switch the state correctly.</p>

<p>Let&rsquo;s create a real state machine in javascript!</p>

<p>So far it doesn&rsquo;t take times for us to figure out that a window should have 4 basic transition state: <code>closed</code>, <code>opening</code>, <code>opened</code>, <code>closing</code>.</p>

<p>A basic transition life cycle of a window could be:</p>

<blockquote><p>(initial) -> closed -> opening -> opened &#8212;&#8212;> closing -> opening &#8212;&#8212;> &#8230;.</p></blockquote>


<p>Now we have 4 states, the next is what&rsquo;s the trigger to states switching?</p>

<p>In finite state machine, what triggers state change is named for <a href="https://en.wikipedia.org/wiki/Finite-state_machine">&lsquo;event&rsquo;</a>.</p>

<p>We know that at least we have 2 events: &lsquo;open&rsquo; and &lsquo;close&rsquo;.</p>

<ul>
<li>&lsquo;open&rsquo; would trigger <code>closed</code> switches to <code>opening</code></li>
<li>&lsquo;close&rsquo; would trigger <code>opened</code> switches to <code>closing</code></li>
<li>If we sends &lsquo;open&rsquo; event into the state machine continously,
the second event would be ignored.
(Exactly it depends on what policy we choose. For example, we could devide &lsquo;opening&rsquo; state into &lsquo;opening-part-1&rsquo; and &lsquo;opening-part-2&rsquo; states. And implement the async state change. But if we need s two-state opening, it sounds like a CSS design problem to me. Let&rsquo;s discuss this later if necessary.)</li>
<li>In order to gurantee the transition does really end and thus being independent from the &lsquo;animationend&rsquo; event(The event here is HTML DOM Event), we need to add a timer between &lsquo;opening&rsquo; and &lsquo;opened&rsquo; state. Also between &lsquo;closing&rsquo; and &lsquo;closed&rsquo; state.</li>
<li>Let&rsquo;s call the new event &lsquo;timeout&rsquo;, the timing we set the timer is right after the transitioning from &lsquo;closed&rsquo; to &lsquo;opening&rsquo;, and from &lsquo;opened&rsquo; to &lsquo;closing&rsquo; successfully occurs.</li>
<li>For some use case we may want to cancel the transition. The &lsquo;cancel&rsquo; event is only valid in &lsquo;opening&rsquo; and &lsquo;closing&rsquo; state.</li>
</ul>


<p>So far, the state machine for transition we have:
<img src="http://i.imgur.com/MmBj2pY.jpg"></p>

<p>Now the problem is, how to represent this machine in javascript?</p>

<p>My anwser is put every transition relevant functions/attributes in another mixin object, which would be mixed into appWindow.prototype:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nb">window</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="s1">&#39;use strict&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">capitalize</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">string</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">+</span> <span class="nx">string</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * This object declares all transition event enum:</span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * * OPEN</span>
</span><span class='line'><span class="cm">   * * CLOSE</span>
</span><span class='line'><span class="cm">   * * FINISH</span>
</span><span class='line'><span class="cm">   * * END</span>
</span><span class='line'><span class="cm">   * * CANCEL</span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * @static</span>
</span><span class='line'><span class="cm">   * @namespace TransitionEvent</span>
</span><span class='line'><span class="cm">   * @type {Object}</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">EVT</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">OPEN</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">CLOSE</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">FINISH</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">END</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">CANCEL</span><span class="o">:</span> <span class="mi">4</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">_EVTARRAY</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;OPEN&#39;</span><span class="p">,</span> <span class="s1">&#39;CLOSE&#39;</span><span class="p">,</span> <span class="s1">&#39;FINISH&#39;</span><span class="p">,</span> <span class="s1">&#39;END&#39;</span><span class="p">,</span> <span class="s1">&#39;CANCEL&#39;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Describe the transition state table.</span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * @example</span>
</span><span class='line'><span class="cm">   * var toState = transitionTable[currentState][event];</span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * The value &quot;null&quot; indicates that the transition won&#39;t happen.</span>
</span><span class='line'><span class="cm">   * </span>
</span><span class='line'><span class="cm">   * @type {Object}</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">transitionTable</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>              <span class="cm">/* OPEN|CLOSE|FINISH|END|CANCEL */</span>
</span><span class='line'>    <span class="s1">&#39;closed&#39;</span><span class="o">:</span>  <span class="p">[</span><span class="s1">&#39;opening&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">],</span>
</span><span class='line'>    <span class="s1">&#39;opened&#39;</span><span class="o">:</span>  <span class="p">[</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;closing&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">],</span>
</span><span class='line'>    <span class="s1">&#39;closing&#39;</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;opened&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;closed&#39;</span><span class="p">,</span> <span class="s1">&#39;closed&#39;</span><span class="p">,</span> <span class="s1">&#39;opened&#39;</span><span class="p">],</span>
</span><span class='line'>    <span class="s1">&#39;opening&#39;</span><span class="o">:</span> <span class="p">[</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;closed&#39;</span><span class="p">,</span> <span class="s1">&#39;opened&#39;</span><span class="p">,</span> <span class="s1">&#39;opened&#39;</span><span class="p">,</span> <span class="s1">&#39;closed&#39;</span><span class="p">]</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * This provides methods and attributes used for transition state handling. It&#39;s not meant to</span>
</span><span class='line'><span class="cm">   * be used directly.</span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * The finite state machine of transition is working as(being from normal state):</span>
</span><span class='line'><span class="cm">   * </span>
</span><span class='line'><span class="cm">   * * `closed`  ---*event* **OPEN** ----------------&gt; `opening`</span>
</span><span class='line'><span class="cm">   * * `opening` ---*event* **END/FINISH/CANCEL** ---&gt; `opened`</span>
</span><span class='line'><span class="cm">   * * `opened`  ---*event* **CLOSE** ---------------&gt; `closing`</span>
</span><span class='line'><span class="cm">   * * `closing` ---*event* **END/FINISH/CANCEL** ---&gt; `closed`</span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * If you want to reuse this mixin in your object, you need to define these attributes: `this.element`</span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * And these method: `this.setVisible()` `this.publish()`</span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * The following callback functions are executed only when the transition state are successfully switched:</span>
</span><span class='line'><span class="cm">   * `_onOpen`</span>
</span><span class='line'><span class="cm">   * `_onClose`</span>
</span><span class='line'><span class="cm">   * `_onEnd`</span>
</span><span class='line'><span class="cm">   * `_onFinish`</span>
</span><span class='line'><span class="cm">   * `_onCancel`</span>
</span><span class='line'><span class="cm">   * `_leaveOpened`</span>
</span><span class='line'><span class="cm">   * `_enterOpened`</span>
</span><span class='line'><span class="cm">   * `_leaveClosed`</span>
</span><span class='line'><span class="cm">   * `_enterClosed`</span>
</span><span class='line'><span class="cm">   * `_leaveClosing`</span>
</span><span class='line'><span class="cm">   * `_enterClosing`</span>
</span><span class='line'><span class="cm">   * `_leaveOpening`</span>
</span><span class='line'><span class="cm">   * `_enterOpening`</span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * Every callback here is for internal usage and would be executed only once.</span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * However you could utilize inner event in other functions.</span>
</span><span class='line'><span class="cm">   * </span>
</span><span class='line'><span class="cm">   *</span>
</span><span class='line'><span class="cm">   * @mixin WindowTransition</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * @event AppWindow#_onTransitionOpen</span>
</span><span class='line'><span class="cm">   * @private</span>
</span><span class='line'><span class="cm">   * @memberof AppWindow</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * @event AppWindow#_onTransitionClose</span>
</span><span class='line'><span class="cm">   * @private</span>
</span><span class='line'><span class="cm">   * @memberof AppWindow</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * @event AppWindow#_onTransitionEnd</span>
</span><span class='line'><span class="cm">   * @private</span>
</span><span class='line'><span class="cm">   * @memberof AppWindow</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * @event AppWindow#_onTransitionFinish</span>
</span><span class='line'><span class="cm">   * @private</span>
</span><span class='line'><span class="cm">   * @memberof AppWindow</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * @event AppWindow#_onTransitionCancel</span>
</span><span class='line'><span class="cm">   * @private</span>
</span><span class='line'><span class="cm">   * @memberof AppWindow</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">WindowTransition</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">TRANSITION_EVENT</span><span class="o">:</span> <span class="nx">EVT</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * _transitionState indicates current transition state of appWindow.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * @memberOf WindowTransition</span>
</span><span class='line'><span class="cm">     * @default</span>
</span><span class='line'><span class="cm">     * @type {String}</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="nx">_transitionState</span><span class="o">:</span> <span class="s1">&#39;closed&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * Record the previous transition state.</span>
</span><span class='line'><span class="cm">     *</span>
</span><span class='line'><span class="cm">     * **Only updated if the state changes successfully.**</span>
</span><span class='line'><span class="cm">     * </span>
</span><span class='line'><span class="cm">     * @type {String|null}</span>
</span><span class='line'><span class="cm">     * @memberOf WindowTransition</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="nx">_previousTransitionState</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * Handle the transition event.</span>
</span><span class='line'><span class="cm">     * @memberOf WindowTransition</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="nx">_transitionHandler</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">aw__transitionHandler</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_cancelTransition</span><span class="p">();</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_processTransitionEvent</span><span class="p">(</span><span class="nx">EVT</span><span class="p">.</span><span class="nx">FINISH</span><span class="p">);</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">_cancelTransition</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">aw__cancelTransition</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">className</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">className</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">className</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;transition-&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">className</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">_enterOpening</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">aw__enterOpening</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="cm">/**</span>
</span><span class='line'><span class="cm">       * @todo set this._unloaded</span>
</span><span class='line'><span class="cm">       */</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">resize</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_unloaded</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">//this.element.style.backgroundImage = &#39;url(&#39; + this._splash + &#39;)&#39;;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Turn of visibility once we&#39;re entering opening state.</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">setVisible</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Make sure the transition is terminated.</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_openingTransitionTimer</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_previousTransitionState</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>            <span class="k">this</span><span class="p">.</span><span class="nx">_previousTransitionState</span> <span class="o">==</span> <span class="nx">from</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>            <span class="k">this</span><span class="p">.</span><span class="nx">_transitionState</span> <span class="o">==</span> <span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">this</span><span class="p">.</span><span class="nx">_processTransitionEvent</span><span class="p">(</span><span class="nx">EVT</span><span class="p">.</span><span class="nx">END</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">_transitionTimeout</span><span class="o">*</span><span class="mf">1.2</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/**</span>
</span><span class='line'><span class="cm">       * @event AppWindow#appwillopen</span>
</span><span class='line'><span class="cm">       * @memberof AppWindow</span>
</span><span class='line'><span class="cm">       */</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">from</span> <span class="o">!==</span> <span class="s1">&#39;opened&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Only publish |willopen| event when previous state is &quot;closed&quot;.</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;willopen&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;transition-opening&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_transition</span><span class="p">[</span><span class="s1">&#39;open&#39;</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">_enterClosing</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">aw__enterClosing</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Make sure the transition is terminated.</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_closingTransitionTimer</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_previousTransitionState</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>            <span class="k">this</span><span class="p">.</span><span class="nx">_previousTransitionState</span> <span class="o">==</span> <span class="nx">from</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>            <span class="k">this</span><span class="p">.</span><span class="nx">_transitionState</span> <span class="o">==</span> <span class="nx">to</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">this</span><span class="p">.</span><span class="nx">_processTransitionEvent</span><span class="p">(</span><span class="nx">EVT</span><span class="p">.</span><span class="nx">END</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">_transitionTimeout</span><span class="o">*</span><span class="mf">1.2</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/**</span>
</span><span class='line'><span class="cm">       * @event AppWindow#appwillclose</span>
</span><span class='line'><span class="cm">       * @memberof AppWindow</span>
</span><span class='line'><span class="cm">       */</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">from</span> <span class="o">!==</span> <span class="s1">&#39;opened&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Only publish |willclose| event when previous state is &quot;opened&quot;.</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;willclose&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;transition-closing&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_transition</span><span class="p">[</span><span class="s1">&#39;close&#39;</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">_processTransitionEvent</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">aw__processTransitionEvent</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">to</span> <span class="o">=</span> <span class="nx">transitionTable</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">_transitionState</span><span class="p">][</span><span class="nx">evt</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">to</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">from</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_transitionState</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">leaveState</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">evt</span><span class="p">);</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">onEvent</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">evt</span><span class="p">);</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">enterState</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">evt</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_previousTransitionState</span> <span class="o">=</span> <span class="nx">from</span><span class="p">;</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_transitionState</span> <span class="o">=</span> <span class="nx">to</span><span class="p">;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">enterState</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">aw_enterState</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">funcName</span> <span class="o">=</span> <span class="s1">&#39;_enter&#39;</span> <span class="o">+</span> <span class="nx">capitalize</span><span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">());</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">funcName</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>          <span class="k">this</span><span class="p">[</span><span class="nx">funcName</span><span class="p">](</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">evt</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">funcName</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">funcName</span><span class="p">]))</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">[</span><span class="nx">funcName</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>            <span class="nx">func</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">evt</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">leaveState</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">aw_leaveState</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">funcName</span> <span class="o">=</span> <span class="s1">&#39;_leave&#39;</span> <span class="o">+</span> <span class="nx">capitalize</span><span class="p">(</span><span class="nx">from</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">());</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">funcName</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>          <span class="k">this</span><span class="p">[</span><span class="nx">funcName</span><span class="p">](</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">evt</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">funcName</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">funcName</span><span class="p">]))</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">[</span><span class="nx">funcName</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>            <span class="nx">func</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">evt</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="p">},</span> <span class="k">this</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">onEvent</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">aw_onEvent</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">funcName</span> <span class="o">=</span> <span class="s1">&#39;_onTransition&#39;</span> <span class="o">+</span> <span class="nx">capitalize</span><span class="p">(</span><span class="nx">_EVTARRAY</span><span class="p">[</span><span class="nx">evt</span><span class="p">].</span><span class="nx">toLowerCase</span><span class="p">());</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_invoke</span><span class="p">(</span><span class="nx">funcName</span><span class="p">);</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">_enterOpened</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">aw__enterOpened</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_cancelTransition</span><span class="p">();</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_openingTransitionTimer</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">window</span><span class="p">.</span><span class="nx">clearTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_openingTransitionTimer</span><span class="p">);</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">_openingTransitionTimer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="cm">/**</span>
</span><span class='line'><span class="cm">       * @event AppWindow#appopen</span>
</span><span class='line'><span class="cm">       * @memberOf AppWindow</span>
</span><span class='line'><span class="cm">       */</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">from</span> <span class="o">==</span> <span class="s1">&#39;opening&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Only publish |open| event when previous state is &quot;opening&quot;.</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">_enterClosed</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">aw__enterClosed</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_cancelTransition</span><span class="p">();</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_closingTransitionTimer</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">window</span><span class="p">.</span><span class="nx">clearTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_closingTransitionTimer</span><span class="p">);</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">_closingTransitionTimer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">setVisible</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/**</span>
</span><span class='line'><span class="cm">       * @event AppWindow#appclose</span>
</span><span class='line'><span class="cm">       * @memberof AppWindow</span>
</span><span class='line'><span class="cm">       */</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">from</span> <span class="o">==</span> <span class="s1">&#39;closing&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Only publish |close| event when previous state is &quot;closing&quot;.</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">publish</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * Set the transition way of opening or closing transition.</span>
</span><span class='line'><span class="cm">     * @param  {String} type       &#39;open&#39; or &#39;close&#39;</span>
</span><span class='line'><span class="cm">     * @param  {String} transition The CSS rule name about window transition.</span>
</span><span class='line'><span class="cm">     * @memberOf WindowTransition</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="nx">_setTransition</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">aw__setTransition</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">transition</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">!=</span> <span class="s1">&#39;open&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">type</span> <span class="o">!=</span> <span class="s1">&#39;close&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">_transition</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="nx">transition</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">AppWindow</span><span class="p">.</span><span class="nx">addMixin</span><span class="p">(</span><span class="nx">WindowTransition</span><span class="p">);</span>
</span><span class='line'><span class="p">}(</span><span class="k">this</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<h5>The state machine&rsquo;s usage and notes</h5>

<ol>
<li>A single app window instance would send &lsquo;open&rsquo; and &lsquo;close&rsquo; event due to user action:
<code>
transitionStateMachine.<em>processEvent(&lsquo;open&rsquo;);
transitionStateMachine.</em>processEvent(&lsquo;close&rsquo;);
</code>
Note, app window doesn&rsquo;t need to know current state of the state machine.</li>
<li>The state machine itself is the one who creates/removes the timer which triggers timeout event. I am also thinking about moving this out of the state machine and do this in another mixin, only have the callback functions provided by the state machine. But I am not sure.</li>
<li>The state machine has some callback for others(other state machine!) listed below:

<ul>
<li>Enter a state successfully.</li>
<li>Leave a state successfully.</li>
<li>When an event triggers state switch successfully.
In all these callback we would get the previous state and current state, and the event who triggers them.</li>
</ul>
</li>
<li>The CSS class for real UI closing animation is added in <code><em>enterClosing</code> and removed in <code></em>enterClosed</code>. Or else we could do that in <code><em>leaveOpened</code> and <code></em>leaveClosing</code>. I have no strong opinion here.
Maybe we could define the level of the callback into three here, according to the callback order.</li>
<li>The CSS class for real UI opening animation is added in <code><em>enterOpening</code> and removed in <code></em>enterOpened</code>.</li>
<li>We could also move out (4) and (5) to another mixin to purify the state machine.</li>
</ol>


<p>Finally, back to the problems addressed in Tim&rsquo;s article:</p>

<ul>
<li>Do we need intermediate state?

<ul>
<li>I don&rsquo;t think so, at least for now. If we really need to goto next state when we successfully from state A to state B, we could call <code>_processEvent</code> again in the inner callback of the state machine. This doesn&rsquo;t violate the policy that only state machine ifself could decide its next state.</li>
<li>If the intermediate state needs to acquire other type of state &mdash; just fetch the current state of the other state machine. Or, if we need, register an one-time callback if the current state doesn&rsquo;t meet our requirement.</li>
</ul>
</li>
<li>How about state conflict between two apps?

<ul>
<li>That won&rsquo;t happen if we deal with the state changes correctly and independently in each app&rsquo;s scope. I hope so.</li>
</ul>
</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[HTML5 Page visibility on Fx OS]]></title>
    <link href="http://alivedise.github.io/blog/2013/07/05/page-visibility-on-firefox-os/"/>
    <updated>2013-07-05T04:23:00+08:00</updated>
    <id>http://alivedise.github.io/blog/2013/07/05/page-visibility-on-firefox-os</id>
    <content type="html"><![CDATA[<p>在桌面版本的網頁開發中，我們可以透過 HTML5 的 page visibility API 來知道目前的網頁是否為使用者焦點，或者目前不可為使用者所見，來達成某些目的：如停止 UI 更新，資料交換&hellip;等，範例程式如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">handleVisibilityChange</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">hidden</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// Pause UI update</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// Begin UI update</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;visibilitychange&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">handleVisibilityChange</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>我們將這個 API 帶到 Firefox OS 中，並賦予了它更深一層的意義：</p>

<!--more-->




<blockquote><p>應用程式判斷自己在前景/背景的依據，類似 android 的 onPause/onResume<br/>系統底層 Low Memory Killer 的參數之一：背景應用程式在可用記憶體過低時會優先被 kill<br/>在電力消耗變成一個必須優先考量要點的手持裝置上，透過進入背景時停止更新 UI 對電力節約有很大幅度的幫助。<br/>然而，在手機系統上，並不像在桌面瀏覽器一樣單純的是透過頁面切換 (onPageShow/onPageHide) 來決定要不要對某個 web page/app 做前景背景切換，而是要根據系統 UI hierarchy 以及當前介面中層級較高的其他元件的狀態來維持 visibility 的協調性。</p></blockquote>


<p>聽起來很抽象嗎？先來張系統模組介面架構圖：
<img src="http://i.imgur.com/ypJSsQg.jpg">
Gaia System Architecture Diagram (source from <a href="https://docs.google.com/drawings/d/18DnhTgQBK3M0KBeLGJkWW1hfiYBB6GgTmfdbUnT2SLs/edit?usp=sharing">https://docs.google.com/drawings/d/18DnhTgQBK3M0KBeLGJkWW1hfiYBB6GgTmfdbUnT2SLs/edit?usp=sharing</a>)</p>

<p>簡單的說，手機系統介面在特定狀態下會將目前已經是前景的 app 設定為背景狀態，其優先層級如下：</p>

<ol>
<li>Screen off (螢幕關閉)</li>
<li>Call screen (電話中介面)</li>
<li>Lockscreen on (手機鎖定介面啟動)</li>
<li>Inline activities (app內嵌 web activities 作用中)</li>
<li>App transition end (app 切換結束)</li>
<li>Back to home (回到 homescreen)</li>
</ol>


<p>而這些事件又可能會同時發生而產生互相影響，如：inline activity 作用時電話打進來，多重 inline activities 中第一次產生的 activity frame 會被第二次的 activity frame 蓋掉&hellip;等。</p>

<p>這些決策發生在哪呢？與桌面瀏覽器不同，決定這一切的是發生在 Gaia，也就是 Firefox OS 的 UI 層：換句話說，是以 JavaScript 撰寫的噢。而實現的方式是系統中各個模組對各個底層 moz-*  API 的 callback 重新包覆並以 custom event 的形式通知其他模組，最後集中給 system app 中的 Window Manager 來做統一管理。</p>

<p>這樣做最大的原因是：只有 Gaia 本身最了解與 UI 相關的一切，而既然 Gecko 將 API expose 出來，只要你對 API 夠熟悉，想要自己用 JavaScript/HTML 實現一個瀏覽器是可能的。</p>

<p>這部份我們可以用一個實例說明：
「裝置從進入閒置狀態，到使用者按下電源鍵，之後解開鎖定螢幕 (LockScreen)」對 visibility 影響的過程：</p>

<h5>Screen is off by idle timeout:</h5>

<ul>
<li>(Gaia) [Screen Manager] mozPower.screenEnabled = false</li>
<li>(Gaia) [Screen Manager] send custom &lsquo;screenchange&rsquo; event</li>
<li>(Gaia) [Lockscreen] get &lsquo;screenchange&rsquo; event, check the settings of &ldquo;lockscreen.enabled&rdquo; and dispatch custom &lsquo;lock&rsquo; event</li>
<li>(Gaia) [Window Manager] get &lsquo;lock&rsquo; event, and then set visibility = false for current app(focused one).</li>
<li>(Gonk) [/sys/power] See mozPower.screenEnabled is modified and send &lsquo;sizemodechange&rsquo; to simulate the content window is minimized.</li>
<li>(Gecko) [shell] Get &lsquo;sizemodechange&rsquo; event, set visibility = false for the whole system app</li>
</ul>


<h5>Turn on screen:</h5>

<ul>
<li>(Gecko) Get keypress event of sleep-button, and then send mozChromeEvent to gaia</li>
<li>(Gaia) [Hardware Button Manager] Get mozChromeEvent with type = &ldquo;sleep-button-press&rdquo;, wrap the event to &lsquo;wake&rsquo; event</li>
<li>(Gaia) [Screen Manager] mozPower.screenEnabled = true</li>
<li>(Gecko) [shell] Get &lsquo;sizemodechange&rsquo; event, set visibility = true for the whole system app
[NOTE] the current app is still invisible now, but the system app is visible.</li>
</ul>


<h5>Unlock the lockscreen:</h5>

<ul>
<li>(Gaia) [Lockscreen] Send custom &lsquo;unlock&rsquo; event.</li>
<li>(Gaia) [Widow Manager] Get &lsquo;unlock&rsquo; event and turn on the active app&rsquo;s visibility.</li>
</ul>


<p>對 App 開發者來說，其實你只要適當地註冊 visibilitychange event handler 去分別處理前景與背景的任務，而維持 visibility state 的正確性與一致性則是作業系統的責任，這也是開發 website/web application 與 web-based OS 之間最大的不同吧：必須同時考慮到過去（已經存在的網頁）/現在（我們正在開發中的內建app）/未來（即將到來的 FirefoxOS app）。</p>

<p>P.S. This is posted at moztech first. See <a href="http://tech.mozilla.com.tw/posts/2020/visibility-api-on-firefox-os-%E5%BE%9E%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F%E5%89%8D%E8%83%8C%E6%99%AF%E6%8E%A7%E5%88%B6%E7%9C%8B-os-%E5%AF%A6%E4%BD%9C">here</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[My first year at Mozilla]]></title>
    <link href="http://alivedise.github.io/blog/2013/07/05/one-year-at-mozilla/"/>
    <updated>2013-07-05T02:31:00+08:00</updated>
    <id>http://alivedise.github.io/blog/2013/07/05/one-year-at-mozilla</id>
    <content type="html"><![CDATA[<h3>Achievements</h3>

<ul>
<li>第一次出國，第一次出差。</li>
<li>工作關係出差四次去了三個國家（美國兩次，德國，西班牙），自己自助旅行去了日本。</li>
<li><a href="https://wiki.mozilla.org/Modules/FirefoxOS#System">變成module peer</a>。</li>
<li>參與了一些以前沒有被發明過的WebAPI的設計或討論。</li>
<li>有了當面試官的經驗。</li>
<li>第一次參加全公司的出遊活動。</li>
<li>對Firefox的layout engine: Gecko送了幾次patch，<a href="http://www.mozilla.org/hacking/committer/">簽了Level 1 Committer賣身契</a>。</li>
<li>寫了數百個各種patch，解了數百個各種bug。</li>
<li>看到很多以前沒有遇過的pattern，現在回去看一年前寫的東西感覺又不同了。</li>
<li>當然也看到一些不好的設計，很希望有機會能夠改變它。</li>
<li>認識一些除了我之外在工作之餘還是對技術玩意很有熱忱的人。</li>
</ul>


<!--more-->


<ul>
<li>目前身分是自由球員，理論上被允許去做任何我想做的事，不太被干涉，我非常，非常喜歡這件事。也很感謝我的主管&#8221;縱容&#8221;我。</li>
<li>養了叫bug的貓。<img src="http://i.imgur.com/JPR0wzu.jpg"></li>
<li><a href="http://coscup.org/2012/en/program/">在COSCUP 2012給過talk</a>。</li>
<li><a href="http://coscup.org/2013/zh-tw/program/">今年還有一次跟FxOS有關的talk</a>。</li>
<li>在柏林的時候人生第一次看到雪。<img src="http://i.imgur.com/ffpaudD.jpg"></li>
</ul>


<h3>Canvas</h3>

<h4>MountainView</h4>

<p><img src="http://i.imgur.com/V1mXfJf.jpg">
<img src="http://i.imgur.com/ytFnxpi.jpg">
<img src="http://i.imgur.com/pCGMHcF.jpg"></p>

<h4>San Francisco</h4>

<p><img src="http://i.imgur.com/2WElJM1.jpg">
<img src="http://i.imgur.com/OBv99Ty.jpg">
<img src="http://i.imgur.com/7u3g8IC.jpg"></p>

<h4>Berlin &ndash; Snow!</h4>

<p><img src="http://i.imgur.com/cO74ubC.jpg">
<img src="http://i.imgur.com/EULi3MV.jpg">
<img src="http://i.imgur.com/tSer20f.jpg">
<img src="http://i.imgur.com/FEtE2wg.jpg"></p>

<h4>Spain</h4>

<p><img src="http://i.imgur.com/eufuWlp.jpg">
<img src="http://i.imgur.com/tbjIL9m.jpg">
<img src="http://i.imgur.com/GkWfumD.jpg">
<img src="http://i.imgur.com/v8Y3472.jpg"></p>

<h4>Japan</h4>

<ul>
<li>自助旅行 &ndash; 是的，這其實跟工作無關，不過也因為是在這裡，請長假出國玩絕對不是太困難的事情。</li>
<li>我在日本期間去了日本Mozilla辦公室 &ndash; 位在六本木，一個很棒的空間。
<img src="http://i.imgur.com/z4ekB4W.jpg">
<img src="http://i.imgur.com/2ErLpTd.jpg">
<img src="http://i.imgur.com/qtQGJuH.jpg">
<img src="http://i.imgur.com/BTRD67c.jpg">
<img src="http://i.imgur.com/q27j5yp.jpg"></li>
</ul>


<h3>While (true) {</h3>

<ul>
<li>還想多用javascript寫一些不同的pattern。</li>
<li>想培養持續玩一些小的side probject的習慣。</li>
<li>想把自己bug track list裡面的bug通通吃完。</li>
<li>想了解gaia裡面某些至今還沒有看完的複雜的應用做了什麼，為了什麼，可以學到什麼。</li>
<li>繼續寫blog吧!</li>
<li>想改變我想改變的事情。

<h3>}</h3></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Recent side projects: Alvitr, Lucifer, GaiaSystemAPIDOC]]></title>
    <link href="http://alivedise.github.io/blog/2013/06/18/alvitr/"/>
    <updated>2013-06-18T12:33:00+08:00</updated>
    <id>http://alivedise.github.io/blog/2013/06/18/alvitr</id>
    <content type="html"><![CDATA[<h3>Alvitr</h3>

<p>Alvitr(艾爾薇妲）是北歐神話中戰女神的其中一名，其名意為「全知」。</p>

<p>最近對某個遊戲(Puzzle &amp; Dragon)很沉迷，
但是在網路上遍尋不著產生簽名檔的服務，
於是就興起了想要自己做的念頭。</p>

<p><a href="http://alivedise.github.io/alvitr">Alvitr</a></p>

<p>大概花了一個禮拜的時間，本來想用Amazon AWS + node.js的組合來用伺服器端產生圖檔，
但是遇到了不少問題如：
1. AWS初始化實在太煩人了。
2. node.js跑起來會莫名的crash，錯誤訊息看起來像是c語言的某個函式。（我不是在寫js嗎？！)</p>

<p>後來還是決定用client端javascript application的形式做，
至少IE9可以支援Canvas。</p>

<!--more-->


<h4>Canvas templating</h4>

<p>因為目標是把使用者輸入的資料轉成不同大小內容配置也不同的圖片，</p>

<p>於是我在想可以針對不同大小圖片弄一個像是configurtaion的物件，每次配置選擇改變只要換掉configuration就好了。</p>

<p>最後成果<a href="https://github.com/alivedise/alvitr/blob/gh-pages/javascripts/client.js">client.js</a></p>

<p>繪圖元件配置不外乎：x, y, weight, height, color等的參數，所以要創造一個新的配置物件只要複製貼上再去微調就好了。</p>

<h3>Lucifer</h3>

<blockquote><p>明亮之星，早晨之子啊，你何竟從天墜落？你這攻敗列國的何竟被砍倒在地上？你心裡曾說：我要升到天上；我要高舉我的寶座在神眾星以上；我要坐在聚會的山上，在北方的極處。我要升到高雲之上；我要與至上者同等。然而，你必墜落陰間，到坑中極深之處。</p></blockquote>


<p><a href="http://alivedise.github.io/lucifer">Lucifer</a></p>

<p>拿某篇文章來開的小玩笑，主要是用了ejs template engine來亂數產生一些怪物資料在文章內。</p>

<h3>Gaia System API Documentation</h3>

<p><a href="http://alivedise.github.io/gaia-system-jsdoc/">Gaia System JSDOC</a>
<a href="https://github.com/alivedise/jsdoc3-bootstrap">JSDOC3 bootstrap template</a>
不知道為什麼jsdoc2我電腦一直裝不成功，jsdoc3倒是很簡單的用npm就裝好了。</p>

<p>找了一下找不到專門給jsdoc3用的好看template&hellip;我就自己套bootstrap上去了，成果如上。</p>

<h3>其他</h3>

<p>我還有一兩個一直很想做的probject&hellip;不過總是因為懶惰作罷:P</p>

<p>回首到Mozilla也一年了，感覺自身還有很多不足&hellip;.
督促自己寫side project只是開始而已，還要再努力阿！</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Javascript從變形矩陣反推scale以及rotate]]></title>
    <link href="http://alivedise.github.io/blog/2013/05/27/rotation-matrix/"/>
    <updated>2013-05-27T15:41:00+08:00</updated>
    <id>http://alivedise.github.io/blog/2013/05/27/rotation-matrix</id>
    <content type="html"><![CDATA[<p>原文：
<a href="http://css-tricks.com/get-value-of-css-rotation-through-javascript/">http://css-tricks.com/get-value-of-css-rotation-through-javascript/</a></p>

<p>今天在追一個跟CSS3 transform有關的bug，
過程中懷疑是transform沒有正確應用到element上。</p>

<p>最後想到用一個Mutation Observer去觀察元素的變形矩陣的某個值（在此例為scale)的變化，
因為transform沒辦法直接用element.style直接拿到scale的值，
所以要用getComputedStyle拿出變形矩陣後算出來：
（skew跟translate的值原文沒有提供算法，看了一下網路文章似乎沒辦法逆推。）</p>

<!--more-->




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Construct a mutation observer.</span>
</span><span class='line'><span class="cm">   * See https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * var target = document.querySelector(&#39;#id&#39;);</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#id&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * create an observer instance</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">observer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MutationObserver</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">mutations</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * We could iterate the mutations here,</span>
</span><span class='line'><span class="cm">     * but I don&#39;t really care it now.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">st</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">getComputedStyle</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">tr</span> <span class="o">=</span> <span class="nx">st</span><span class="p">.</span><span class="nx">getPropertyValue</span><span class="p">(</span><span class="s2">&quot;-webkit-transform&quot;</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>             <span class="nx">st</span><span class="p">.</span><span class="nx">getPropertyValue</span><span class="p">(</span><span class="s2">&quot;-moz-transform&quot;</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>             <span class="nx">st</span><span class="p">.</span><span class="nx">getPropertyValue</span><span class="p">(</span><span class="s2">&quot;-ms-transform&quot;</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>             <span class="nx">st</span><span class="p">.</span><span class="nx">getPropertyValue</span><span class="p">(</span><span class="s2">&quot;-o-transform&quot;</span><span class="p">)</span> <span class="o">||</span>
</span><span class='line'>             <span class="nx">st</span><span class="p">.</span><span class="nx">getPropertyValue</span><span class="p">(</span><span class="s2">&quot;transform&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Matrix: &#39;</span> <span class="o">+</span> <span class="nx">tr</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// rotation matrix - http://en.wikipedia.org/wiki/Rotation_matrix</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="nx">tr</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'>    <span class="nx">values</span> <span class="o">=</span> <span class="nx">values</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>    <span class="nx">values</span> <span class="o">=</span> <span class="nx">values</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">values</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">values</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">values</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">values</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">scale</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">a</span><span class="o">*</span><span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="o">*</span><span class="nx">b</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// arc sin, convert from radians to degrees, round</span>
</span><span class='line'>    <span class="c1">// DO NOT USE: see update below</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">sin</span> <span class="o">=</span> <span class="nx">b</span><span class="o">/</span><span class="nx">scale</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">angle</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">asin</span><span class="p">(</span><span class="nx">sin</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">180</span><span class="o">/</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// works!</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Scale: &#39;</span> <span class="o">+</span> <span class="nx">scale</span> <span class="o">+</span> <span class="s1">&#39;;Rotate: &#39;</span> <span class="o">+</span> <span class="nx">angle</span> <span class="o">+</span> <span class="s1">&#39;deg&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">    * Configuration of mutation observer.</span>
</span><span class='line'><span class="cm">    */</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">attributes</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">childList</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">characterData</span><span class="o">:</span> <span class="kc">true</span> <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * pass in the target node, as well as the observer options</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="nx">observer</span><span class="p">.</span><span class="nx">observe</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">config</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[From browser to browser. (1)]]></title>
    <link href="http://alivedise.github.io/blog/2013/02/23/from-browser-to-browser/"/>
    <updated>2013-02-23T17:40:00+08:00</updated>
    <id>http://alivedise.github.io/blog/2013/02/23/from-browser-to-browser</id>
    <content type="html"><![CDATA[<h3>Firefox OS</h3>

<p><img src="http://cdn0.mos.techradar.futurecdn.net///art/mobile_phones/Mozilla/FireFoxOS/DeveloperHandsets/FirefoxOSDev-Press-01-580-75.jpg"></p>

<h3>System app</h3>

<p>Exactly, Firefox OS, also known for boot 2 gecko, is having only one app/one page.
It&rsquo;s the system app, which controls all web app&rsquo;s life cycle.
When FirefoxOS is booted, it would load the system app from <code>system/index.html</code>.
Then system app would take care of the remaing stuff.</p>

<ul>
<li>Load modules</li>
<li>Init homescreen app</li>
<li>Etc.</li>
</ul>


<!--more-->


<h3>Window Manager</h3>

<p>Window Manager is the core of Firefox OS, the core of system app, which is in charge of creating/maintaining/killing apps.
An app, indeed, is a web page.</p>

<p>We use a magic, calling browser API, to make a web page act like an app.</p>

<h3>Browser API</h3>

<p>See <a href="https://developer.mozilla.org/en-US/docs/DOM/Using_the_Browser_API">https://developer.mozilla.org/en-US/docs/DOM/Using_the_Browser_API</a></p>

<p>A browser here means that the web page acts like it is living in a browser <code>frame</code>.
We are replacing nearly every XUL-based UI with HTML to <code>port</code> the WEB to the phone.</p>

<h3>Module Pattern</h3>

<p>Module pattern is the way Window Manager being imeplemented.
A module pattern looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">WindowManager</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">_running</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">createApp</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>     <span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">();</span>
</span><span class='line'>     <span class="nx">_running</span><span class="p">[</span><span class="nx">_id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">app</span><span class="p">;</span>
</span><span class='line'>     <span class="nx">_id</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>     <span class="k">return</span> <span class="nx">app</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">killApp</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">delete</span> <span class="nx">_running</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">create</span><span class="o">:</span> <span class="nx">createApp</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">kill</span><span class="o">:</span> <span class="nx">killApp</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">})();</span>
</span></code></pre></td></tr></table></div></figure>


<p>Thus the Window Manager object only has 2 public attributes.
This looks fine, but it would be a nightmare if this pattern grows to over 2000 lines.
And it&rsquo;s having countless private functions now.</p>

<p>This module now is not unit testable nor maintainable.</p>

<h3>Break it!</h3>

<h4>From the browser to the browser</h4>

<p>Let&rsquo;s define a new object to contain and manage itself in its own scope.</p>

<p>It&rsquo;s called <code>browserFrame</code>.</p>

<h5>The responsibility of browserFrame</h5>

<p>It would create an iframe with all attributes needed for BrowserAPI.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* Define a basic mozbrowser iframe class.</span>
</span><span class='line'><span class="cm"> * It creates a mozbrowser iframe,</span>
</span><span class='line'><span class="cm"> * and finally returns the DOM element it just created.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">BrowserFrame</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="nx">invocation</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">BrowserFrame</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// This constructor function is a local variable.</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">element</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">nextId</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">callbacks</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>    <span class="nx">createFrame</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="c1">// All arguments are values to createFrame</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">BrowserFrame</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">&#39;browser&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// These are helper functions and variables used by the methods above</span>
</span><span class='line'>  <span class="c1">// They&#39;re not part of the public API of the module, but they&#39;re hidden</span>
</span><span class='line'>  <span class="c1">// within this function scope so we don&#39;t have to define them as a</span>
</span><span class='line'>  <span class="c1">// property of Browser or prefix them with underscores.</span>
</span><span class='line'>  <span class="kd">function</span> <span class="nx">createFrame</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">origin</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">manifestURL</span><span class="p">,</span> <span class="nx">oop</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">browser</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;iframe&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">browser</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;mozallowfullscreen&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Most apps currently need to be hosted in a special &#39;mozbrowser&#39; iframe.</span>
</span><span class='line'>    <span class="c1">// They also need to be marked as &#39;mozapp&#39; to be recognized as apps by the</span>
</span><span class='line'>    <span class="c1">// platform.</span>
</span><span class='line'>    <span class="nx">browser</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;mozbrowser&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">oop</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">browser</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;remote&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">manifestURL</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">browser</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;mozapp&#39;</span><span class="p">,</span> <span class="nx">manifestURL</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">origin</span><span class="p">)</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">origin</span> <span class="o">=</span> <span class="nx">origin</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">browser</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">browser</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">className</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">browser</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">BrowserFrame</span><span class="p">.</span><span class="nx">className</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Store the element</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">element</span> <span class="o">=</span> <span class="nx">browser</span><span class="p">;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">nextId</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="c1">// The public API for this module is the Browser() constructor function.</span>
</span><span class='line'>  <span class="c1">// We need to export that function from this private namespace so that</span>
</span><span class='line'>  <span class="c1">// it can be used on the outside. In this case, we export the constructor</span>
</span><span class='line'>  <span class="c1">// by returning it. It becomes the value of the assignment expression</span>
</span><span class='line'>  <span class="c1">// on the first line above.</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">BrowserFrame</span><span class="p">;</span>
</span><span class='line'><span class="p">}());</span> <span class="c1">// Invoke the function immediately after defining it.</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Mocha: MockMozActivity與global leak]]></title>
    <link href="http://alivedise.github.io/blog/2013/02/23/mock-moz-activity/"/>
    <updated>2013-02-23T16:56:00+08:00</updated>
    <id>http://alivedise.github.io/blog/2013/02/23/mock-moz-activity</id>
    <content type="html"><![CDATA[<p>之前在寫單元測試時，需要測到MozActivity的呼叫。</p>

<p>當我們嘗試去取代window object中的MozActivity時，會遇到：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>0) Feed "before all" hook: Error: global leak detected:</span></code></pre></td></tr></table></div></figure>


<p>解決方法：</p>

<!--more-->


<p>在程式前面加上<code>mocha.setup({ignoreLeaks: true});</code></p>

<p>最後加上<code>mocha.setup({ignoreLeaks: true});</code></p>

<p>碰到這個錯誤是在嘗試加入假的MozActivity給window時。</p>

<p>因為要被測試的module中有如下的程式片段：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'>  <span class="k">new</span> <span class="nx">MozActivity</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;view&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">data</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="nx">url</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>去呼叫browser app開啟某個特定網頁，</p>

<p>但是mocha跑的環境中有可能：</p>

<ol>
<li>並沒有window.MozActivity這個物件。</li>
<li>有MozActivity但是我們無法知道他是否被呼叫。</li>
</ol>


<p>這時候需要塞一個MockMozActivity給window，暫時取代掉原本的MozActivity，</p>

<p>然後從MockMozActivity裡面留個變數記錄被呼叫的參數狀況來判斷程式是否正確的執行呼叫activity。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">mockMozActivityInstance</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">MockMozActivity</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">MozActivity</span><span class="p">(</span><span class="nx">configuration</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">property</span> <span class="k">in</span> <span class="nx">configuration</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">=</span> <span class="nx">configuration</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">mockMozActivityInstance</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>之後寫的測試內容：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// Captive Portal Test</span>
</span><span class='line'>  <span class="nx">test</span><span class="p">(</span><span class="s1">&#39;system/captive portal login w/o manual enable wifi&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">CaptivePortal</span><span class="p">.</span><span class="nx">handleEvent</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">MockSettingsListener</span><span class="p">.</span><span class="nx">mCallback</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">mockMozActivityInstance</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s1">&#39;view&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>人生第一個單元測試程式完成 \O/</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Javascript memorization]]></title>
    <link href="http://alivedise.github.io/blog/2012/12/22/javascript-memorization/"/>
    <updated>2012-12-22T00:28:00+08:00</updated>
    <id>http://alivedise.github.io/blog/2012/12/22/javascript-memorization</id>
    <content type="html"><![CDATA[<p>As you know, function in javascript is also an object,
you could use a property of the object to keep function result.
This is called <code>Memorization</code>.</p>

<p>Today I have a chance to utilize this skill.</p>

<p>Please read codes below first:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">getOffOrigin</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">frame</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">url</span> <span class="o">?</span> <span class="nx">app</span><span class="p">.</span><span class="nx">frame</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">url</span> <span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">frame</span><span class="p">.</span><span class="nx">src</span><span class="p">,</span> <span class="nx">origin</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">subtitle</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">subtitle</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">getOffOrigin</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">frame</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">url</span> <span class="o">?</span> <span class="nx">app</span><span class="p">.</span><span class="nx">frame</span><span class="p">.</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">url</span> <span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">frame</span><span class="p">.</span><span class="nx">src</span><span class="p">,</span> <span class="nx">origin</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">card</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">subtitle</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<!--more-->


<p><code>getOffOrigin</code> has to use some logic to compare the two arguments and return a string.
The result wouldn&rsquo;t change if the arguments are the same.
Therefore, to avoid calling the function many times, the result could be stored in the function itself.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="kd">function</span> <span class="nx">getOffOrigin</span><span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="nx">origin</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Use src and origin as cache key</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">cacheKey</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">));</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">getOffOrigin</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">cacheKey</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="kr">native</span> <span class="o">=</span> <span class="nx">getOriginObject</span><span class="p">(</span><span class="nx">origin</span><span class="p">);</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">getOriginObject</span><span class="p">(</span><span class="nx">src</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">current</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">==</span> <span class="s1">&#39;http:&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Display http:// protocol anyway</span>
</span><span class='line'>        <span class="nx">getOffOrigin</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">cacheKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">+</span> <span class="s1">&#39;//&#39;</span> <span class="o">+</span> <span class="nx">current</span><span class="p">.</span><span class="nx">hostname</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="kr">native</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">==</span> <span class="nx">current</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>          <span class="kr">native</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">==</span> <span class="nx">current</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>          <span class="kr">native</span><span class="p">.</span><span class="nx">port</span> <span class="o">==</span> <span class="nx">current</span><span class="p">.</span><span class="nx">port</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Same origin policy</span>
</span><span class='line'>        <span class="nx">getOffOrigin</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">cacheKey</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">current</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">==</span> <span class="s1">&#39;app:&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Avoid displaying app:// protocol</span>
</span><span class='line'>        <span class="nx">getOffOrigin</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">cacheKey</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">getOffOrigin</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">cacheKey</span><span class="p">]</span> <span class="o">=</span> <span class="nx">current</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">+</span> <span class="s1">&#39;//&#39;</span> <span class="o">+</span> <span class="nx">current</span><span class="p">.</span><span class="nx">hostname</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="nx">getOffOrigin</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">cacheKey</span><span class="p">];</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">getOffOrigin</span><span class="p">.</span><span class="nx">cache</span> <span class="o">=</span> <span class="p">{};</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><p>If we only have one arguments we could use it as the key to cache directly.
But we have multiple arguments in this case, we then use stringilized JSON to be the key.</p></li>
<li><p>Hence we don&rsquo;t need to do the same thing every time we enter this function if the arguments are used before.</p></li>
<li><p>Have fun with your function cache!</p></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Web activity]]></title>
    <link href="http://alivedise.github.io/blog/2012/09/04/web-activity/"/>
    <updated>2012-09-04T15:45:00+08:00</updated>
    <id>http://alivedise.github.io/blog/2012/09/04/web-activity</id>
    <content type="html"><![CDATA[<p>Web activity是由Mozilla設計並開發，用來使web app之間共享資源的框架。
在Firefox OS中已經存在Platform/UI上的實作，並且有一些內建的主要Web app已經利用Web activity來達成跨應用程式溝通的目的。
（如：Gallery使用它來讓其他程式從它挑選圖片，也用同一技術來實現圖片分享到不同應用）</p>

<p>以下介紹如何使用這個新穎的技術。</p>

<!--more-->


<h3>Request</h3>

<p>假設今天E-mail應用程式需要從圖片集中挑選圖片來寄送，
那麼它必須新增一個Activity物件如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'>  <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MozActivity</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;browse&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;image/png&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;...&#39;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>type欄位是用來當filter用的
在data中的其他欄位可以傳你想要的資料給接收方。</p>

<p>當收到資料後，處理回呼函數的方式：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'>  <span class="nx">a</span><span class="p">.</span><span class="nx">onsuccess</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">on_success</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">image</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>  <span class="nx">a</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">on_error</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;error when picking!&#39;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Reciever</h3>

<p>接受某個Activity的App必須在Manifest.webapp中宣告：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="s2">&quot;activities&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>   <span class="s2">&quot;pick&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>     <span class="s2">&quot;filters&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>       <span class="nx">type</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;image/png&quot;</span><span class="p">,</span> <span class="s2">&quot;image/gif&quot;</span><span class="p">],</span>
</span><span class='line'>     <span class="p">},</span>
</span><span class='line'>     <span class="s2">&quot;disposition&quot;</span><span class="o">:</span> <span class="s2">&quot;window&quot;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>並且在自己的javascript檔中寫好當Activity產生時的處理函式</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">navigator</span><span class="p">.</span><span class="nx">setMozMessageHandler</span><span class="p">(</span><span class="s1">&#39;activity&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">image</span> <span class="o">=</span> <span class="nx">getImageToReturn</span><span class="p">();</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">image</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">a</span><span class="p">.</span><span class="nx">postError</span><span class="p">(</span><span class="s2">&quot;NoImage&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">a</span><span class="p">.</span><span class="nx">postResult</span><span class="p">({</span> <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;image/png&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="o">:</span> <span class="nx">image</span> <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h4>data/type的用法</h4>

<p>如聯絡人程式可以接受同一個叫做pick的Activity，
但是電子郵件程式需要的是&#8217;email&#8217;這類資料，
而電話程式需要的是&#8217;號碼&#8217;這類資料，
對於這兩類資料需要呈現的UI與最後傳回去的資料當然會是不一樣的。</p>

<p>解決方法就是利用不同的data type來區分同種activity的不同需求：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'>  <span class="c1">// Email app</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MozActivity</span><span class="p">({</span>
</span><span class='line'>      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;pick&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;web-content/email&#39;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'>  <span class="c1">// Dialer app</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MozActivity</span><span class="p">({</span>
</span><span class='line'>      <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;pick&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;web-content/numbers&#39;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>在聯絡人程式中</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">navigator</span><span class="p">.</span><span class="nx">setMozMessageHandler</span><span class="p">(</span><span class="s1">&#39;activity&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">switch</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="s1">&#39;webcontacts/numbers&#39;</span><span class="o">:</span>
</span><span class='line'>      <span class="c1">// ...</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="k">case</span> <span class="s1">&#39;webcontacts/email&#39;</span><span class="o">:</span>
</span><span class='line'>      <span class="c1">// ...</span>
</span><span class='line'>      <span class="k">break</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>如此一來就可以分開處理UI變化及後續回傳資料的部分。</p>

<h3>多於一個可以處理的Reciever?</h3>

<p>比如圖片應用程式可以分享的對象有兩個以上的時候，
Firefox OS的系統UI便會自動列出可用的應用程式清單，如圖：
<img src="http://i.imgur.com/V2rgq.jpg">
<img src="http://i.imgur.com/xcgBK.png">
<img src="http://i.imgur.com/UpaOC.png"></p>

<h3>結論</h3>

<p>Web activity是一個實驗中的新功能，雖然還有一些地方未盡完善，
但是看著它從spec到platform implementation到UI implementation，
就好像親身參與了網路/網頁進化的過程一樣。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[gaia] HTML5 Window Shade]]></title>
    <link href="http://alivedise.github.io/blog/2012/07/05/gaia-window-shade/"/>
    <updated>2012-07-05T13:58:00+08:00</updated>
    <id>http://alivedise.github.io/blog/2012/07/05/gaia-window-shade</id>
    <content type="html"><![CDATA[<h1>Window Shade</h1>

<p>我手上的Samsung Galaxy S3的作業系統是Android 4.0.4。</p>

<p>當我收到facebook/google+/&hellip;等程式通知的時候，最上面那條bar會出現對應的圖示。</p>

<p>這時候可以透過將bar「滑下來」的動作拉出一個UI，裡面會有</p>

<ol>
<li>快速設定</li>
<li>通知項目詳細列表</li>
</ol>


<p><img src="http://i.imgur.com/nU76i.png"></p>

<p>這個UX，Google把它稱為<b>Window shade</b></p>

<!--more-->


<p>神奇的地方在於當你在拉下或拉上面板的同時，
快速設定與通知項目是會先「掉下來」到底端，
到了項目的頂端出現之後才會黏在頂部。
（相信我你沒有特別注意這件事情，而且用久了會覺得理所當然）</p>

<h1>GAIA也有notification panel</h1>

<p>Firefox OS的UI &ndash; <a href="http://github.com/mozilla-central/gaia">GAIA</a>裡面也有定義功能列以及通知面板這件事，
這個功能正在開發中。</p>

<p>有一天我們收到某個contributor提交的pull request：</p>

<p><a href="https://github.com/mozilla-b2g/gaia/pull/1898">Gaia pull request#1898</a>
節錄重要的修改如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="nx">onTouchMove</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">ut_onTouchMove</span><span class="p">(</span><span class="nx">touch</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">screenHeight</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">overlay</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">().</span><span class="nx">height</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">gripBarHeight</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">gripBar</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">().</span><span class="nx">height</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">dy</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">startY</span> <span class="o">-</span> <span class="nx">touch</span><span class="p">.</span><span class="nx">pageY</span><span class="p">),</span>
</span><span class='line'>        <span class="nx">newHeight</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">shown</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">dy</span> <span class="o">+=</span> <span class="nx">screenHeight</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">dy</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">screenHeight</span><span class="p">,</span> <span class="nx">dy</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">dy</span> <span class="o">&gt;</span> <span class="nx">gripBarHeight</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">quickSettingsHeight</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">quickSettings</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">().</span><span class="nx">height</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">dy</span> <span class="o">&lt;</span> <span class="nx">quickSettingsHeight</span> <span class="o">+</span> <span class="nx">gripBarHeight</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">newHeight</span> <span class="o">=</span> <span class="nx">screenHeight</span> <span class="o">-</span> <span class="nx">quickSettingsHeight</span> <span class="o">-</span> <span class="nx">gripBarHeight</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">newHeight</span> <span class="o">=</span> <span class="nx">screenHeight</span> <span class="o">-</span> <span class="nx">dy</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">quickSettings</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">MozTransition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">quickSettings</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">MozTransform</span> <span class="o">=</span> <span class="s1">&#39;translateY(&#39;</span> <span class="o">+</span> <span class="nx">newHeight</span> <span class="o">+</span> <span class="s1">&#39;px)&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">style</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">overlay</span><span class="p">.</span><span class="nx">style</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">style</span><span class="p">.</span><span class="nx">MozTransition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">style</span><span class="p">.</span><span class="nx">MozTransform</span> <span class="o">=</span> <span class="s1">&#39;translateY(&#39;</span> <span class="o">+</span> <span class="nx">dy</span> <span class="o">+</span> <span class="s1">&#39;px)&#39;</span><span class="p">;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="c1">//....skiped...</span>
</span><span class='line'>  <span class="nx">show</span><span class="o">:</span> <span class="kd">function</span> <span class="nx">ut_show</span><span class="p">(</span><span class="nx">dy</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">alreadyShown</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">shown</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">trayStyle</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">overlay</span><span class="p">.</span><span class="nx">style</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">quickSettingsStyle</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">quickSettings</span><span class="p">.</span><span class="nx">style</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">trayStyle</span><span class="p">.</span><span class="nx">MozTransition</span> <span class="o">=</span> <span class="s1">&#39;-moz-transform 0.2s linear&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">trayStyle</span><span class="p">.</span><span class="nx">MozTransform</span> <span class="o">=</span> <span class="s1">&#39;translateY(100%)&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">quickSettingsStyle</span><span class="p">.</span><span class="nx">MozTransition</span> <span class="o">=</span> <span class="s1">&#39;-moz-transform 0.2s linear&#39;</span><span class="p">;</span>
</span><span class='line'>    <span class="nx">quickSettingsStyle</span><span class="p">.</span><span class="nx">MozTransform</span> <span class="o">=</span> <span class="s1">&#39;translateY(0px)&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">shown</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">screen</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;utility-tray&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">alreadyShown</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">evt</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createEvent</span><span class="p">(</span><span class="s1">&#39;CustomEvent&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">evt</span><span class="p">.</span><span class="nx">initCustomEvent</span><span class="p">(</span><span class="s1">&#39;utilitytrayshow&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
</span><span class='line'>      <span class="nb">window</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="nx">evt</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>原作者提到他做這件事是要讓<code>quick-setting</code>更快的出現。
這段code也已經被merge了。</p>

<h1>不過就在昨天同事發現了一個關於功能列的issue</h1>

<p>於是我開始看發生了什麼事。然後上面那兩個function耗費了我一個下午&hellip;.XD</p>

<p>@colinfrei其實做了一件非常有趣但是很難從code裡面看出端倪的事情。
甚至也很難用語言來描述，不過我想試著說明發生了什麼事，怎麼做到的。</p>

<p>簡單的說，他利用兩個「不同」區塊的CSS3的Transition「同步化」來實現剛剛所提的Window Shade的行為。</p>

<h2>CSS: Transition</h2>

<p><a href="https://developer.mozilla.org/en/CSS/transition">參閱MDN: transition</a></p>

<h2>CSS: Transform</h2>

<p><a href="https://developer.mozilla.org/en/CSS/transform">參閱MDN: transform</a></p>

<h1>真相其實是：</h1>

<ol>
<li><code>utility-tray</code>是一個絕對定位的<code>div</code>，平常位置定在螢幕上方<code>-moz-calc(100% &ndash; UTILITY_TRAY_HEIGHT)</code>。</li>
<li><p>當你開始Touch的時候，根據你的移動距離計算<code>translateY</code>，使它產生位移</p>

<p> 你可以把<code>-moz-transform: translateY(px)</code>當成是<code>top: px</code>在CSS3的新招。
 它提供了更快速的rendering &mdash; 當你想利用<code>-moz-transition: -moz-transform</code>來做位移動畫的時候。
 這件事情可以另外寫一篇文章來說（挖洞的意味）。</p></li>
<li><p>當你放開拉bar的時候而且如果已經超過「要讓通知面板掉下來的合法距離」：</p>

<ul>
<li>設定一個<code>MozTransition</code>給<code>utility-tray-overlay</code></li>
<li>再設定一個<code>MozTransition</code>給<code>quick-setting</code></li>
</ul>
</li>
</ol>


<p>4.讓<code>utility-tray</code>整個以某個定速掉下來到螢幕底端 + 讓<code>quick-setting</code>以同樣的定速往上移動到<code>utility-tray</code>的開端</p>

<p>  = 於是就造成了<code>quick-setting</code>似乎黏在通知列下方不動但整個面板是往下掉的假象！</p>

<h1>the story continues</h1>

<p>不過可惜的是似乎沒有考慮到當通知面板要滑上去的時候，</p>

<p>「有物件的部份也應該留在頂端直到被拉bar撞到一起彈上去」這件事</p>

<p>於是我也仿造這個作法另外送了一個pull request</p>

<p><a href="https://github.com/mozilla-b2g/gaia/pull/2181">GAIA pull request#2181</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="k">case</span> <span class="s1">&#39;transitionend&#39;</span><span class="o">:</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">shown</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">this</span><span class="p">.</span><span class="nx">screen</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="s1">&#39;utility-tray&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">overlayStyle</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">overlay</span><span class="p">;</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">firstShownStyle</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">firstShowStyle</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">firstShownStyle</span><span class="p">.</span><span class="nx">MozTransition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">phase2hide</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">firstShownStyle</span><span class="p">.</span><span class="nx">MozTransition</span> <span class="o">=</span> <span class="s1">&#39;-moz-transform 0.2s linear&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">firstShownStyle</span><span class="p">.</span><span class="nx">MozTransform</span> <span class="o">=</span>
</span><span class='line'>          <span class="s1">&#39;translateY(&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">firstShownPosition</span> <span class="o">+</span> <span class="s1">&#39;px)&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">overlayStyle</span><span class="p">.</span><span class="nx">MozTransition</span> <span class="o">=</span> <span class="s1">&#39;-moz-transform 0.2s linear&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">overlayStyle</span><span class="p">.</span><span class="nx">MozTransform</span> <span class="o">=</span> <span class="s1">&#39;translateY(0)&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Check the transition event is triggered at firstShown.</span>
</span><span class='line'>        <span class="c1">// If so, turn off the flag which represent for</span>
</span><span class='line'>        <span class="c1">// &#39;The overlay has already reached the bottom of quick-setting&#39;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">target</span> <span class="o">==</span> <span class="k">this</span><span class="p">.</span><span class="nx">firstShown</span><span class="p">)</span>
</span><span class='line'>          <span class="k">this</span><span class="p">.</span><span class="nx">phase2hide</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Reset position of this.firstShown</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">firstShown</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">MozTransition</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">firstShown</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">MozTransform</span> <span class="o">=</span> <span class="s1">&#39;translateY(0)&#39;</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">break</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>利用<code>transitionend</code> event callback，透過連續兩次的<code>Transition</code>來：</p>

<ol>
<li>讓<code>utility-tray</code>先定速往上移動/讓<code>quick-setting</code>定速往下移動到底端。</li>
<li>等到<code>utility-tray</code>的transition結束時，會收到<code>transitionend</code>的事件。
 這時候再讓<code>utility-tray</code>進行第二次transition&hellip;而目的地就是螢幕頂端。
 同時<code>quick-setting</code>就不再動作了，讓它跟著<code>utility-tray</code>一起被往上卷走。</li>
</ol>


<h2>transitionend</h2>

<p><a href="https://developer.mozilla.org/zh_tw/CSS_%E8%BD%89%E5%A0%B4#.E5.81.B5.E6.B8.AC_transition_.E7.9A.84.E5.AE.8C.E6.88.90">參閱MDN: transitionend</a></p>

<h1>the end?</h1>

<p>其實UX還沒有定義這個行為，所以pull request本身沒有被接受。
不過&hellip;I did learn something from these codes:)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[WEB] Web Application Core]]></title>
    <link href="http://alivedise.github.io/blog/2012/06/10/web-application-core/"/>
    <updated>2012-06-10T17:06:00+08:00</updated>
    <id>http://alivedise.github.io/blog/2012/06/10/web-application-core</id>
    <content type="html"><![CDATA[<p>最近看到這篇文章<a href="http://addyosmani.github.com/backbone-aura/">Backbone Aura</a>難得的有提到一個web application core該做些什麼事情？跟我想的蠻相似的，這邊將他列出來：
* 管理widget的life cycle的能力。
* 低階DOM操作處理
* 提供publish/subscribe的溝通管道給應用程式的各部位互相溝通</p>

<p>以下是我流解析。</p>

<h2>管理widget的life cycle</h2>

<p>Core是應用程式的進入點(entry poing)，它必須在適當的時機init需要的widget/application part起來做事情，也只有Core才知道什麼時候必須做這些事情。當然也包括在適當的時機讓widget沈睡或消滅。</p>

<h2>低階DOM操作</h2>

<p>這有點像jQuery library主要在做的事情，不過世界上不是只有jQuery一種library，也不是任何情況下都可以用jQuery，有一個可以快速操作DOM的方法是必要的。</p>

<h2>提供publish/subscribe的溝通方式</h2>

<p>解耦後的application part/widget當然不能直接呼叫別人的attribute function（不然還解什麼耦），那要怎麼叫別人做事？行之有年的publish/subscribe機制在jmvc已經被整合進去，backbone上面還欠缺方法，backbone aura把這件事做出來了。</p>

<p>然後因為好奇它怎麼做的就看了一下source，在<code>aura/www/js/aura/mediator.js</code>裡面定義了：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Subscribe to an event</span>
</span><span class='line'><span class="cm"> * @param {string} channel Event name</span>
</span><span class='line'><span class="cm"> * @param {object} subscription Module callback</span>
</span><span class='line'><span class="cm"> * @param {object} context Context in which to execute the module</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="nx">obj</span><span class="p">.</span><span class="nx">subscribe</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="nx">channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">])</span> <span class="o">?</span> <span class="p">[]</span> <span class="o">:</span> <span class="nx">channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">];</span>
</span><span class='line'>    <span class="nx">channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">context</span><span class="p">));</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Publish an event, passing arguments to subscribers. Will</span>
</span><span class='line'><span class="cm"> * call start if the channel is not already registered.</span>
</span><span class='line'><span class="cm"> * @param {string} channel Event name</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="nx">obj</span><span class="p">.</span><span class="nx">publish</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">channel</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">obj</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">][</span><span class="nx">i</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>看起來是利用一個變數來根據widget name儲存callback function進array裡面。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[javascript] function hoisting應用]]></title>
    <link href="http://alivedise.github.io/blog/2012/06/10/function-hoisting-appliance/"/>
    <updated>2012-06-10T16:17:00+08:00</updated>
    <id>http://alivedise.github.io/blog/2012/06/10/function-hoisting-appliance</id>
    <content type="html"><![CDATA[<h1>function hoisting是什麼？</h1>

<p>一個不說你也不會知道的js語言特性，是指js看到function xxx(){}這種宣告時會把定義搬到scope最頂端
的行為，hoisting的意思是提昇。</p>

<p>自從在Javascript Patterns這本書上面看到hoisting的時候，就一直在想到底有什麼場合可以用到這個奇妙的語言特性？想不到還真的遇到了，雖然其實是個反例XD</p>

<p>原文出自PTT Web_Design版「<a href="http://www.ptt.cc/bbs/Ajax/M.1339127132.A.226.html">[問題] jQuery 參數的問題~</a>」，這名網友問為什麼下面的js不能用？</p>

<!--more-->




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#test&quot;</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="nx">aaa</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">aaa</span><span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;yo&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>好傻好天真？</h2>

<p>雖然不知道為什麼提問者堅持要把函數宣告放在用它之前，不過既然他問了，剛好這情況可以利用function hoisting來做，只是要修改一些小地方。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#test&quot;</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="nx">aaa</span><span class="p">);</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">aaa</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;yo&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cm">/* function expression instead of function declaration */</span>
</span></code></pre></td></tr></table></div></figure>


<p>我另外寫了一個jsfiddle來測試：</p>

<iframe style="width: 100%; height: 300px" src="http://jsfiddle.net/Ytmqw/embedded/js,resources,html,css,result/light/"></iframe>


<h1>做的到，只不過真的有必要嗎？</h1>

<p>真的有太多理由不建議這樣做。原po在我回文後也沒出現，看來也無從得知他這樣做的理由了。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[把assignment變數轉成JSON格式]]></title>
    <link href="http://alivedise.github.io/blog/2012/05/31/underline-to-json/"/>
    <updated>2012-05-31T10:53:00+08:00</updated>
    <id>http://alivedise.github.io/blog/2012/05/31/underline-to-json</id>
    <content type="html"><![CDATA[<p>從Server端收到的資訊是如下格式</p>

<pre><code>user_i0_name=alive
user_i0_gender=male
user_i0_age=27
user_i0_company_c0_name=VIVOTEK
user_i0_company_c1_name=Mozilla
system_model=ABC1234
network_hostname=abc1234
</code></pre>

<p>但是這些資訊很難使用，想透過某個統一的方法把它轉成object來用。
另外存回去的時候要把object轉回跟上面一樣的assignment。</p>

<h1>Step#1: eval拆解進區域變數</h1>

<p>為了避免污染全域變數，前後取代原本的字串：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">string_rev_1</span> <span class="o">=</span> <span class="p">((</span><span class="s1">&#39;object[\&#39;&#39;</span><span class="o">+</span><span class="nx">string</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\r\n$/</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\r\n/gi</span><span class="p">,</span> <span class="s1">&#39;\r\nobject[\&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/=/gi</span><span class="p">,</span> <span class="s1">&#39;\&#39;]=&#39;</span><span class="p">));</span>
</span><span class='line'><span class="nb">eval</span><span class="p">(</span><span class="nx">string_rev_1</span><span class="p">);</span>
</span><span class='line'><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>現在得到了一個只有一層的object，是好用了一點，但是能不能切出多層來？</p>

<h1>Step#2: 用底線切object</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">string_rev_2</span> <span class="o">=</span> <span class="nx">string_rev_1</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/_/gi</span><span class="p">,</span> <span class="s1">&#39;\&#39;&#39;</span><span class="p">][</span><span class="err">\</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>但是這樣會有undefined的問題，如</p>

<pre><code>user_i0_name=alive
</code></pre>

<p>會變成</p>

<pre><code>object['user']['i0']['name']=alive
</code></pre>

<p>eval後會出現<code>i10 is undefined.</code>
所以要想辦法解決這種超前reference的狀況。</p>

<p>一個辦法是用<code>\r\n</code>切分assignment後個別eval，再用try catch區塊判斷是否發生超前定義的情況。
假設發生了就個別處理該assignment。</p>

<p>(待續)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[CanJS簡介]]></title>
    <link href="http://alivedise.github.io/blog/2012/05/30/can-js/"/>
    <updated>2012-05-30T17:33:00+08:00</updated>
    <id>http://alivedise.github.io/blog/2012/05/30/can-js</id>
    <content type="html"><![CDATA[<h1>CanJS是什麼？</h1>

<p>CanJS是JMVC團隊把MVC這一塊獨立出來的結果，並且做了一些改良。以往談到JavascriptMVC跟Backbone的時候，其實這兩個框架的目的是不同的。
JMVC除了MVC還提供其他的case solution，而Backbone只專注在MVC身上。另外一個不同點是JMVC當時的MVC framework只能綁定在jQuery上面，Backbone可以把核心抽換成zepto(一個類似于jQuery但輕量化的js lib)，這也是有手機網頁app使用backbone卻沒有人使用jmvc的原因。</p>

<h1>CanJS</h1>

<p><a href="http://canjs.us">CanJS官網</a>
以下節錄幾個要點：</p>

<ol>
<li>核心可抽換成Zepto, jQuery, YUI, Dojo, Mootools。</li>
<li>非常快，
<img src="http://bitovi.com/images/introducing-canjs/performance_control.png">
<img src="http://bitovi.com/images/introducing-canjs/performance_livebind.png">
比較令我訝異的是backbone竟然沒有live binding功能？</li>
<li>安全的Model。jqueryMX一個缺點是常常會有內容相同的model instance，CanJS解決了這點。它保證相同內容的Object只會有一個instance。</li>
<li>View可以做live binding了，直接對應Model change。</li>
</ol>


<h1>展望</h1>

<p>以往JMVC為人詬病的就是本身提供的東西太複雜，不會有全部學完的動力。看來CanJS可以在專心這件事上趕上Backbone。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[「WEB」我也有一個故事要說。]]></title>
    <link href="http://alivedise.github.io/blog/2012/05/30/i-have-also-a-story-to-tell/"/>
    <updated>2012-05-30T04:15:00+08:00</updated>
    <id>http://alivedise.github.io/blog/2012/05/30/i-have-also-a-story-to-tell</id>
    <content type="html"><![CDATA[<p>這個部落格在我的定位中是純技術取向，但這篇應該會是唯一一篇非關技術的文章。</p>

<p>文長。</p>

<p>我在確定得到新工作的那一天，在ptt soft_job以及web_design版發表了那段時間的面試心得，內容是有關前端工程師的工作面試經歷。（文章在<a href="http://www.ptt.cc/bbs/Soft_Job/M.1335873183.A.F23.html">http://www.ptt.cc/bbs/Soft_Job/M.1335873183.A.F23.html</a>）因為那篇文章我收到很多回應，也很感謝所有來信的人的鼓勵。就在明天我將要離開現在的公司然後到新公司報到，我想在這邊簡單寫下一個平凡的網頁工程師一路走來的心路歷程。一些細碎片段構成的過往。</p>

<p><img src="http://i.imgur.com/CB6eE.jpg"></p>

<!--more-->


<h3>0</h3>

<p>我是一個普通的大學畢業生，大學混了六年才畢業。相當然爾在就業市場上只能任人魚肉，剛退伍時進入了一間要做嵌入式系統的公司。而我幾乎什麼也不會，就只有一個在學歷上跌倒的經驗而已。</p>

<h3>1</h3>

<p>如前文所講，沒寫過網頁之前我很看不起寫網頁的人。現在呢？真的覺得WEB很有意思。技術發展很快又很廣，隨便找一項鑽研都能玩很久。每天睜開眼都有新的東西產生。<b>你永遠不會覺得無聊</b>。</p>

<p>大家都知道新人就是要打雜，而寫網頁這件事本身在某些公司就是一種雜務。不幸的是在公司某些部門內，網頁都會丟給新人負責，新人來了再給新人。裡面充滿着陳舊不堪參疵不齊的程式碼，那個年代jQuery剛崛起，會看到js檔內有部分jQuery寫法，有部分是javascript原生寫法。而我第一個案子就是接手這樣的網頁開發新功能。結束之後仍然不知道自己會了什麼。</p>

<p>第二個案子是作一個很龐大的web application，而這個案子一拖就是快兩年，也是我初嘗開發網頁快樂與痛苦的來源。</p>

<h3>2</h3>

<p><img src="http://i.imgur.com/CMRWv.jpg"></p>

<p>題外話，你們知道嗎，IPAD上有一款app叫zite，它會根據你看文章的喜好來決定要給你什麼material。唯一的缺點是不支援中文，文章source都是英文，不過英文資源本來就多於中文。所以當你看完一篇在寫css hack的文章，旁邊就有選項問你喜不喜歡，順便列出跟css相關的tag給你toggle。你會收到越來越多你想要的相關知識。我有一陣子睡前會躺在床上抱著ipad看新技術文章看到睡著。</p>

<p>即使是最漫長的那段日子也是一樣。</p>

<h3>3</h3>

<p><img src="http://i.imgur.com/R7n2P.png"></p>

<p>我認為部落格的蓬勃發展很大的促進了技術分享這件事。當你遇到問題的時候你會google，而解決你的問題的通常是來自某個熱血的開發者的部落格的某篇獨門心得。我一開始只把這些部落格當成解決問題的手段，平常沒事不會去看。</p>

<p>但後來有天我突然覺得沒有他們日子會很難過，而這時候我也確定自己想走web這一塊。我開始注意每個web developer的部落格，其中提到非技術的部分。<b>很大一部分在說自己對於這一塊的熱情與期望。</b>
檯面上的技術心得文，檯面下往往是要十倍百倍於文字量的熱情支撐。</p>

<p>比如熱血的前Y!前端工程師Josephj(我從他的部落格知道F2E這個字的意義。)</p>

<p>比如版上很熱心的TonyQ大大在版上的每篇熱心文章。</p>

<p>比如我剛進前公司時發現公司裡面有個好人前輩有在經營部落格分享自己在open source的知識跟經驗，那時候就很想認識他但覺得自己不是個咖所以沒膽去搭訕認識。</p>

<p>比如這個中國人寫的部落格：<a href="http://coolshell.cn">酷殼</a>，作者是Amazon中國研發經理，
裡面的文章不一定全都跟Web相關，我第一次讀是從這篇開始：<a href="http://coolshell.cn/articles/1932.html">哥是玩程序的</a>。但後來我發現更有價值的東西不只是javascript相關的有趣文章，而是他的工作思想，是他提倡<b>將工作提升到事業層次</b>這個想法，
如：<a href="http://coolshell.cn/articles/6346.html">程序員因為女孩而美麗！</a>，<a href="http://coolshell.cn/articles/7186.html">做個環保主義的程序員</a>，<a href="http://coolshell.cn/articles/6142.html">三個事與三個問題</a></p>

<p>然後我也開始自己寫部落格，是因為有天看到某篇文章說，現在工程師面試需要的是：自己經營的技術部落格，github上的帳號等等。然後我就這麼做了，申請github帳號，先用自己的NAS架wordpress，後來覺得很難用，看到XDite等前輩在推octopress，剛好github也可以玩，就轉到github pages發展了。</p>

<p>以上這些跟我的工作其實都沒有直接關係，都是利用下班的空閒時間做的。</p>

<h3>4</h3>

<p><img src="http://i.imgur.com/V8dg6.jpg" title="有人問我這是什麼？最後一個下班者拿走鑰匙的簽名。被跳過的平常日期是：沒回家。" ></p>

<p>然後就是那個一直被傳頌的故事。</p>

<p>我不知道是不是每一間公司都有保全系統。我們公司跟中X保全簽約，每一天必須關門的時間是半夜12點。這半年來我每一天幾乎都超過12點下班，今年初變本加厲到凌晨3,4,5,6,7,8點，然後隔天依然九點半上班。我每天晚上都會打電話給中x保全說我要加班，請延長保全時間。到後來他們都知道了，只要我們公司過了半夜兩點還沒設定保全，他們會直接打電話到我私人手機問我在不在公司。</p>

<p>而我通常都在。</p>

<p>嗯，我知道你要問為什麼？</p>

<p>前公司並不是很重視WEB技術，但這個專案的規格跟複雜度遠遠超出他們的輕蔑。對當時的我來說，我覺得以自己當時的知識完全不足以開發出那個大型Web Application，但也只能硬著頭皮幹。隨著專案時間越拉越長，無止盡的會議，UI上的功能需求越改越多，越來越複雜，到我離開的時候整個網站介面翻掉了七次之多。就像OSDC中那個需求變更的lighting talk講的好，<b>權威人士握有對你的東西的最高指導權。</b>而你毫無反應，只是個底層的前端工程師。連Interface Designer都可以決定你的生死(畫一個很難實現的按鈕/對話框/視窗你就準備寫CSS寫到爽了)。到最後其實案子已經有點失控，所以我就跳出來說：「好吧，如果沒人想寫下並定好這些規格那我來寫。」</p>

<p>這是去年十月的事情，而，這是地獄的開端。</p>

<p>每天白天跟作風非常強勢的QA用電話討論UI spec細節，晚上利用空檔寫functional spec，一邊改網頁到符合spec。這段時間平均下班時間是11點~1點，直到某天公司總務發群體信說中X保全抱怨我們超過時間，我才知道原來要加班要先打電話給保全。寫了兩個月終於完成spec第一版，圖文並茂六萬字word。但是根本沒有時間去補足那千餘個功能，因為只有我一個人在做WEB。然後有趣的是上頭很急著進測，他們認為spec寫完就是完成了一切，當然不是。進測結果很糟糕，大部分是未完成功能與ui文字拼寫等UI bug。</p>

<p>我在這段期間還一邊接觸了一些新的技術，因為我想利用MVC框架來解決那些我在這個web application上遇到的種種奇特困難。案子被QA退回後，上頭重新檢討認為是spec不夠詳細嚴謹，於是兩位主管級跳下來接手spec重寫。我自己利用這段時間拼命研究各種網路上的資源。</p>

<h3>5</h3>

<p><img src="http://i.imgur.com/6FkRe.jpg"></p>

<p>我選擇的技術叫JavascriptMVC，是一個total solution client side MVC framework。與它相似的東西是Backbone.js，而最近這段期間我也體悟到其實backbone比較多人在用。也很多人問我為什麼當時不用backbone? 我的答案很簡單，當時花了兩天熬夜做不出一個簡單的起始範例，backbone的文件實在令我費解，就放棄了，</p>

<p>我並沒有太多時間。</p>

<p>當然不只backbone跟jmvc，為了解決問題我也看了YUI, extJS, 甚至zk。我還花時間研究extJS的對話框是怎樣用div拼出來的，那噁心的東西。還有我順便買了一台Synology的NAS回家研究他們怎麼做出那麼漂亮的東西。</p>

<h3>6</h3>

<p>選定JMVC之後一切就順利了嘛？當然不是。這東西在台灣甚至大陸根本沒人在用，網路上清一色都是用backbone。連英文資源也不多。我遇到問題只能到官方forum用破爛英文問作者這功能是什麼？還被嫌棄過我寫的字句他看不懂:D</p>

<p>斷斷續續利用工作空檔時間看jmvc doc兩三個月之後我終於動手對那個改不動的噁心網頁做了refactor。整個砍掉重寫。這次花了三個月的時間寫了五萬行code。重點是，主管並不支持我做重構這件事。而我認為不重構的話某些該死的複雜功能根本無以實現。</p>

<p>我們的想法有衝突，而<b>我只是個想把這件事情做好的死心眼的傢伙。</b>我就在幾乎得不到任何support的情況下開始了進階版的地獄：平均下班時間延長到凌晨兩三點。有段時間每個禮拜會有一天通宵然後隔天不請假繼續上班。</p>

<p>支持我的信念只是相信自己辦的到。但，我曾有很多次在凌晨四五點回到家，洗澡的時候跌坐在地上任熱水沖淋，問自己「這一切到底有何意義？」即使是現在，我也不認為自己是因為那段時間的拼命而獲得一份好的工作，你知道的，努力跟回報從來都不是成正比。但當你真心愛某件事，過程才是重點。</p>

<h3>7</h3>

<ul>
<li>最痛苦的事情不是每天加班，而是你的主管在這段期間不但沒幫你，還處於某種狀況之下導致常常對自己發動言語精神攻擊。</li>
<li>畢竟我只是個人微言輕的小工程師，沒有拿出成果之前，一切都是白搭，不管你多有熱情，對其他人來說「做不到」他們要的東西，你講話就不會有分量。</li>
<li><p>「孤立無援」是一句成語，可以用來造句。對我來說是殘酷的現實。因為最後實做的人是你，不管你有什麼困難，都是你家的事。不管你<code>rhino debugger多難用Makefile多難寫dir-based namespace pattern多難改resize event delegation在IE8出了什麼問題收不到對話框多難刻用js模擬dbus請求多難搞同時採用不同來源data model並行多難做多重ActiveX callback多難整按鈕不同尺寸css sprite多難寫</code>，別人只看得到UI最後的模樣，你做不出來就是你無能，你說做得出來就是「不管我壓什麼時間都做得出來」。</p>

<p>  「你到底有沒有珍惜這份工作？」某天晚上七點主管把我叫進會議室檢討。他不滿意我的進度，給了我很爛的評價。
  你知道眼前坐在椅子上不發一語的我，昨天趕你要的東西沒睡覺嗎？
  我就算不是你最強的員工，也是你最拼命的員工，你該珍惜的不是別人給你的案子的評價，而是身為你員工的我。</p></li>
</ul>


<h3>8</h3>

<p>然後我趕上了不可能的deadline，終於覺得累了，  release的隔天我便打開104更新履歷然後放著。</p>

<h3>9</h3>

<p>原本只是想換一間重視技術也重視web的公司待，沒有預期自己一定會去哪。收到Mozilla的面試邀約，我很驚訝他們有要找Frontend，當然被他們錄取我更suprise。直到現在我依然不得不壓抑自己內心的激動，畢竟，那可是Mozilla。身為一個F2E Newbie，竟然可以在那邊跟全世界的高手們cowork，並且有機會見到一些此領域的大師級人物（jQuery的創始者John Resig曾經待過Mozilla）。</p>

<p>而Mozilla本身想要做某些事情來改變網際網路的未來讓網路變得更好，而，改變網路就幾乎等於著手<u>改變這個世界的未來。</u></p>

<p>有幸參與這個過程，怎能叫人不興奮？</p>

<p>但，你知道的，激情並不是能永久持續的狀態。我現在必須努力把這份激動壓抑下來，然後希望自己永遠莫忘初衷。</p>

<br/>


<p>以上是一個剛起步的小小前端工程師的一段經歷，希望對讀到這篇文章的人有幫助。</p>

<p>Alive Kuo@20120530</p>

<h1>Q&amp;A</h1>

<ol>
<li>有人問第4段的那張手寫日期表是什麼？最後一個下班者拿走公司鑰匙的簽名。被我懶得寫跳過的平常日期是：沒回家。假日來公司：不會記。</li>
</ol>

]]></content>
  </entry>
  
</feed>
